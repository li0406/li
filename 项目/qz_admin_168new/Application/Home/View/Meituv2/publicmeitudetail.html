<extend name="Main:baseTemplate" />
<block name="title">
    <title>公装美图</title>
</block>
<block name="style">
    <link rel="stylesheet" type="text/css"
        href="/assets/common/js/plugins/fileinput/fileinput.min.css?v={:C('STATIC_VERSION')}" />
    <link href="/assets/home/css/bootstrap-switch.min.css?v={:C('STATIC_VERSION')}" rel="stylesheet"
        type="text/css" />
    <link rel="stylesheet"
        href="/assets/common/plugins/select2/css/select2.css?v={:C('STATIC_VERSION')}" />
    <link rel="stylesheet" href="/assets/home/css/style.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet"
        href="/assets/common/js/plugins/fileinput/fileinputLink.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" type="text/css"
        href="/assets/common/js/plugins/datetimepicker/datetimepicker.css?v={:C('STATIC_VERSION')}" />
</block>

<block name="content">
    <section class="content-header">
        <h1>公装美图管理</h1>
        <ol class="breadcrumb">
            <li><a href="/"><i class="fa fa-dashboard"></i> 控制面板</a></li>
            <li class="active"><a href="/pubmeitu">公装美图管理</a></li>
        </ol>
    </section>
    <section class="content">
        <div class="box box-info">
            <div class="form-horizontal">
                <div class="f-title"><i class="glyphicon glyphicon-tag"></i><span>美图操作</span></div>
                <div class="box-body pl60">

                    <div class="form-group">
                        <div class="col-sm-12">标题：</div>
                        <div class="col-sm-5" id="meitu_biaoti">
                            <input id="bt-title" class="form-control" autocomplete="off" name="title" value=""
                                placeholder="标题">
                        </div>
                        <div class="col-sm-5 tips link-error"></div>
                    </div>
                    <volist name="categorylist" id="vo">
                        <div class="form-group">
                            <div class="col-sm-12">{$vo.name}</div>
                            <div class="col-sm-12" style="position: relative;font-weight:normal;">
                                <ul class="item">
                                    <volist name="vo.child" id="v">
                                        <li data-id="{$v.id}">{$v.name}</li>
                                    </volist>
                                </ul>
                                <div class="col-sm-6 tips ctips link-error"></div>
                            </div>

                        </div>
                    </volist>
                    <div class="form-group">
                        <div class="col-sm-12">关键字</div>
                        <div class="col-sm-5">
                            <input id="biaoti2" class="form-control" name="keyword" value="">
                        </div>
                        <div class="col-sm-5 link-error tips"></div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-12">描述</div>
                        <div class="col-sm-5">
                            <textarea id="biaoti3" type="text" name="description" class="form-control" placeholder="描述"
                                style="height:100px;"></textarea>
                        </div>
                        <div class="col-sm-5 link-error tips"></div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-12">是否推荐</div>
                        <div class="col-sm-5">
                            <select name="isRecommend" id="" style="width: 100%;height:34px;">
                                <option value="2" selected>否</option>
                                <option value="1">是</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-12">预发布日期（可不填写，若填写则在填写的日期当天优先发布）</div>
                        <div class="col-sm-3">
                            <input type="text" placeholder="预发布时间" class="form-control datetime" name="start_time"
                                value="" autocomplete="off">
                        </div>
                    </div>
                    <div class="form-group img-wrap">
                        <div class="col-sm-12">美图：</div>
                        <div class="col-sm-8">
                            <input id="uploadPic" type="file" multiple />
                            <input type="hidden" name="files" />
                        </div>
                        <div class="col-sm-1 link-error tips"></div>
                    </div>
                    <div class="form-group">
                        <div class="col-xs-4">
                            <div class="alert alert-warning alert-dismissible fade in " role="alert">
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                                        aria-hidden="true">×</span></button>
                                <strong>注意事项：</strong> 图片大小现不设限制，但请控制图片不要太大哦！
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-xs-5">
                            <button type="submit" class="btn btn-success button submit-save" data-state="1">保存</button>
                            <button type="submit" class="btn btn-info button submit-save" data-state="3">直接发布</button>
                            <button type="button" class="btn btn-default" onclick="history.back()"><i
                                    class="fa fa-mail-reply"></i>&nbsp;返回</button>
                        </div>
                        <input type="hidden" name="caseid" value="{$meitu.id}" />
                    </div>
                </div>
            </div>
        </div>
    </section>
</block>
<block name="script">
    <script type="text/javascript" src="/assets/common/js/plugins/fileinput/fileinputLink.js?v={:C('STATIC_VERSION')}">
    </script>
    <script type="text/javascript"
        src="/assets/common/js/plugins/fileinput/fileinput_locale_zh.js?v={:C('STATIC_VERSION')}"></script>
    <script charset="utf-8" src="/assets/home/js/bootstrap-switch.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/common/plugins/select2/js/select2.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/common/plugins/select2/js/zh-CN.js?v={:C('STATIC_VERSION')}"></script>
    <script
        src="/assets/common/js/plugins/datetimepicker/bootstrap-datetimepicker.js?v={:C('STATIC_VERSION')}">
    </script>
    <script type="text/javascript" src="/assets/common/plugins/layer/layer.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript">
        function msg(msg, fn) {
            layer.msg (
                msg,
                {time: 2000,},
                fn || function () {
                }
            )
        }
        var imageHost =  '{$imageHost}';
        $(document).ready(function () {
            var geturl = location.href;
            var img_src, img_title,img_width,img_height,img_http;
            if (geturl.indexOf('?') != -1) {
                var url = decodeURI(location.href)
                var id = url.split('?')[1].split('=')[1];
                ajaxFun();
                $("#uploadPic").fileinput({
                    language: 'zh', //设置语言,
                    uploadUrl: "/upload/uploadimg/",
                    showCaption: false,
                    maxFileCount: 1,
                    autoReplace: true,
                    browseClass: "btn blue",
                    allowedFileExtensions: ['jpg', 'png'],
                    uploadClass: "btn green",
                    // removeClass:"btn red",
                    uploadAsync: true,
                    dropZoneEnabled: false,
                    maxFileSize: 1000000000,
                    previewSettings: {
                        image: {
                            width: "auto",
                            height: "100px"
                        }
                    },
                    //是否覆盖初始设置的或者之前的
                    overwriteInitial: true,
                    uploadExtraData: {
                        prefix: 'meitu'
                    },
                    initialPreview: [
                        "<img src='" + img_http +
                        "' class='file-preview-image'>"
                    ],
                    initialPreviewAsData: true,
                    initialPreviewFileType: 'image',
                    initialPreviewConfig: [{
                        url: "",
                        text: img_title
                    }]
                }).on('fileuploaded', function (event, data) {
                    var _this = $(this);
                    if (data.response.status == 1) {
                        var Imgs = $("input[name=files]").data("data");
                        if (typeof Imgs == "undefined") {
                            Imgs = [];
                        }
                        img = {
                            name: data.response.data.name
                        }
                        Imgs.push(img);
                        $("input[name=files]").data("data", Imgs);
                        img_src = data.response.data.name;
                    } else {

                    }
                }).on("fileuploaderror", function (event, data) {
                    var _this = $(this);
                    return false;
                }).on("fileclear", function () {
                    $("input[name=files]").val("");
                    img_src = '';
                }).on("change",function(){
                    img_src = '';
                }).on('filebatchselected', function (evt, file) {
                    // 选择图片后执行，用于判断选择的图片是否超出限制，这是为了弥补maxFileCount的bug
                    if($('.file-input').find('.file-preview-frame').length > 1) {
                        layer.msg('仅允许上传1张，请删除多余的图片再上传')
                        // 禁用选择按钮
                        $('#imgUpload').attr('disabled', 'disabled');
                        $('#imgUpload').closest('div.btn-file').addClass('btn-disabled');
                        // 禁用上传按钮
                        $('.file-input').find('.fileinput-upload-button').attr('disabled', 'disabled')
                    }
                }).on('fileremoved', function () {
                    // 该事件钩子针对只选择不上传的情况
                    if($('.file-input').find('.file-preview-frame').length <= 1) {
                        $('#imgUpload').removeAttr('disabled')
                        $('#imgUpload').closest('div.btn-file').removeClass('btn-disabled')
                        $('.file-input').find('.fileinput-upload-button').removeAttr('disabled')
                    }
                })
                //保存按钮
                $(".submit-save").click(function (event) {
                    //检查标题
                    $(".tips").html("");
                    $(".focus").removeClass('focus');
                    var _this = $(this);
                    if ($("input[name=title]").val() == "") {
                        $("input[name=title]").focus();
                        $("input[name=title]").parent().parent().find(".tips").html("请输入标题");
                        return false;
                    }
                    // 热门、商用、生活、公用分类
                    var pub_category;
                    $(".item").each(function () {
                        var item = $(this);
                        if (item.children('li').hasClass('active')) {
                            item.children('li').each(function(i,e){
                                pub_category = item.find('.active').attr('data-id');
                            })
                        } else {
                            $('.ctips').eq(3).html('请选择至少一个分类');
                        }
                    });

                    $(".item").each(function () {
                        var item = $(this);
                        if (item.children('li').hasClass('active')) {
                            $('.ctips').eq(3).hide();
                        }
                    });
                    if ($("input[name=keyword]").val() == "") {
                        $("input[name=keyword]").focus();
                        $("input[name=keyword]").parent().parent().find(".tips").html("请填写关键字");
                        return false;
                    }
                    if ($("textarea[name=description]").val() == "") {
                        $("textarea[name=description]").focus();
                        $("textarea[name=description]").parent().parent().find(".tips").html("请填写描述");
                        return false;
                    }

                    var publishtime = $("input[name=start_time]").val();
                    if ('undefined' == typeof (publishtime)) {
                        publishtime = '';
                    };
                    var data = {
                        type: 1,
                        id:id,
                        title: $("input[name=title]").val(),
                        pub_category: pub_category,
                        keyword: $("input[name=keyword]").val(),
                        description: $("textarea[name=description]").val(),
                        is_recommend: $("select[name=isRecommend").val(),
                        publish_time: publishtime,
                        image_width:img_width,
                        image_height: img_height
                    }

                    //获取上传的图片
                    if (img_src == '') {
                        $('.img-wrap').find(".tips").html("请上传图片");
                        return false;
                    };
                    data.image_src = img_src;
                    data.image_title = $('.textarea').html();

                    data.state = $(this).attr('data-state');
                    $.ajax({
                            url: '/meituv2/saveMeitu',
                            type: 'POST',
                            dataType: 'JSON',
                            data: data
                        })
                        .done(function (data) {
                            if (data.code == 0) {
                                window.location.href = "/meituv2/publicmeitulist";
                            } else {
                                $("#bt-title").focus();
                                if(data.msg == '标题不能重复哦'){
                                    $('.tips').eq(0).html('标题不能重复哦');
                                }else{
                                    $('.tips').eq(0).html('');
                                }
                            }
                        });
                });

                function ajaxFun() {
                    $.ajax({
                        url: "/meituv2/getMeituDetail/",
                        dataType: 'json',
                        async: false,
                        type: 'GET',
                        delay: 1000,
                        data: {
                            id: id,
                            type: 1
                        }, //查询参数*/
                        success: function (data) {
                            if (data.code == 0) {
                                var list = data.data;
                                $("input[name=title]").val(list.title);
                                var pub_category = list.pub_category;
                                $(".item li").each(function (i) {
                                    var item = $(this);
                                    if (item.attr('data-id') == pub_category) {
                                        item.addClass('active');
                                    }
                                });
                                $("input[name=keyword]").val(list.keyword);
                                $("textarea[name=description]").val(list.description);
                                $('select[name=isRecommend]').val(list.is_recommend);
                                $("input[name=start_time]").val(list.publish_time);
                                img_src = list.image_src;
                                img_http = '//' + list.image_src_total;
                                img_title = list.image_title;
                                img_width = list.image_width;
                                img_height = list.image_height;



                            } else {
                                console.log(data.msg)
                            }
                        },
                        fail: function () {

                        }
                    })
                }
            } else {
                //保存按钮
                $(".submit-save").click(function (event) {
                    //检查标题
                    $(".tips").html("");
                    $(".focus").removeClass('focus');
                    var _this = $(this);
                    if ($("input[name=title]").val() == "") {
                        $("input[name=title]").focus();
                        $("input[name=title]").parent().parent().find(".tips").html("请输入标题");
                        return false;
                    }
                    // 热门、商用、生活、公用分类
                    var pub_category;
                    $(".item").each(function () {
                        var item = $(this);
                        if (item.children('li').hasClass('active')) {
                            item.children('li').each(function(i,e){
                                pub_category = item.find('.active').attr('data-id');
                            })
                        } else {
                            $('.ctips').eq(3).html('请选择至少一个分类');
                        }
                    });
                    $(".item").each(function () {
                        var item = $(this);
                        if (item.children('li').hasClass('active')) {
                            $('.ctips').eq(3).hide();
                        }
                    });
                    if ($("input[name=keyword]").val() == "") {
                        $("input[name=keyword]").focus();
                        $("input[name=keyword]").parent().parent().find(".tips").html("请填写关键字");
                        return false;
                    }
                    if ($("textarea[name=description]").val() == "") {
                        $("textarea[name=description]").focus();
                        $("textarea[name=description]").parent().parent().find(".tips").html("请填写描述");
                        return false;
                    }

                    var publishtime = $("input[name=start_time]").val();
                    if ('undefined' == typeof (publishtime)) {
                        publishtime = '';
                    };
                    var data = {
                        type: 1,
                        title: $("input[name=title]").val(),
                        pub_category: pub_category,
                        keyword: $("input[name=keyword]").val(),
                        description: $("textarea[name=description]").val(),
                        is_recommend: $("select[name=isRecommend").val(),
                        publish_time: publishtime,
                        image_width:img_width,
                        image_height: img_height
                    }

                    //获取上传的图片
                    if ($("input[name=files]").data("data") == undefined) {
                        $('.img-wrap').find(".tips").html("请上传图片");
                        return false;
                    };
                    var img_desc = [],
                        img_id = [];
                    $(".file-preview-frame").each(function (k, y) {
                        var img_desc_html = $(this).find('.textarea').html(); //富文本框
                        img_desc.push({
                            text: img_desc_html
                        });
                    });

                    data.image_src = $("input[name=files]").data("data")[0].name;
                    data.image_title = img_desc[0].text;

                    data.state = $(this).attr('data-state');

                    $.ajax({
                            url: '/meituv2/saveMeitu',
                            type: 'POST',
                            dataType: 'JSON',
                            data: data
                        })
                        .done(function (data) {
                            if (data.code == 0) {
                                window.location.href = "/meituv2/publicmeitulist";
                            } else {
                                $("#bt-title").focus();
                                if(data.msg == '标题不能重复哦'){
                                    $('.tips').eq(0).html('标题不能重复哦');
                                }else{
                                    $('.tips').eq(0).html('');
                                }
                            }
                        });
                });
                //上传图片

                var imgUpload = $("#uploadPic").fileinput({
                    language: 'zh', //设置语言,
                    uploadUrl: "/upload/uploadimg/",
                    showCaption: false,
                    maxFileCount: 1,
                    autoReplace: true,
                    browseClass: "btn blue",
                    allowedFileExtensions: ['jpg', 'png'],
                    uploadClass: "btn green",
                    // removeClass:"btn red",
                    uploadAsync: true,
                    dropZoneEnabled: false,
                    maxFileSize: 1000000000,
                    previewSettings: {
                        image: {
                            width: "auto",
                            height: "100px"
                        }
                    },
                    //是否覆盖初始设置的或者之前的
                    overwriteInitial: true,
                    uploadExtraData: {
                        prefix: 'meitu'
                    },
                    initialPreview: [],
                    initialPreviewAsData: true,
                    initialPreviewFileType: 'image',
                    initialPreviewConfig: []
                }).on('fileuploaded', function (event, data) {
                    var _this = $(this);
                    if (data.response.status == 1) {
                        var Imgs = $("input[name=files]").data("data");
                        if (typeof Imgs == "undefined") {
                            Imgs = [];
                        }
                        img = {
                            name: data.response.data.name
                        }
                        Imgs.push(img);
                        $("input[name=files]").data("data", Imgs);
                        img_width = data.response.data.image_size[0];
                        img_height = data.response.data.image_size[1];
                    } else {
                        /*
                        _this.Alert({
                            msg:data.response.info,
                            level:2
                        });
                        */
                    }
                }).on("fileuploaderror", function (event, data) {
                    var _this = $(this);
                    /*
                    _this.Alert({
                        msg:"附件上传失败,请联系技术部门！",
                        level:2
                    });
                    */
                    return false;
                }).on("fileclear", function () {
                    $("input[name=files]").val("");
                }).on('filebatchselected', function (evt, file) {
                    // 选择图片后执行，用于判断选择的图片是否超出限制，这是为了弥补maxFileCount的bug
                    if($('.file-input').find('.file-preview-frame').length > 1) {
                        layer.msg('仅允许上传1张，请删除多余的图片再上传')
                        // 禁用选择按钮
                        $('#imgUpload').attr('disabled', 'disabled');
                        $('#imgUpload').closest('div.btn-file').addClass('btn-disabled');
                        // 禁用上传按钮
                        $('.file-input').find('.fileinput-upload-button').attr('disabled', 'disabled')
                    }
                }).on('fileremoved', function () {
                    // 该事件钩子针对只选择不上传的情况
                    if($('.file-input').find('.file-preview-frame').length <= 1) {
                        $('#imgUpload').removeAttr('disabled')
                        $('#imgUpload').closest('div.btn-file').removeClass('btn-disabled')
                        $('.file-input').find('.fileinput-upload-button').removeAttr('disabled')
                    }
                })
            }

            $("#meitu_biaoti").on("click", "li", function () {
                $("#bt-title").val($(this).text());
                $(".tishi_box").remove();
            });

            $(document).click(function (event) {
                $(".tishi_box").remove();
            });

            $('#bt-title').on('keyup paste', function () {
                var that = $(this);
                var nextNode = $(this).next(".tishi_box").length;
                if (nextNode == 0) {
                    $(this).after("<div class='tishi_box'><ul></ul></div>");
                }
                if ($(this).val() == "") {
                    $(".tishi_box").remove();
                }

                var text = $(this).val();
                var type = $(this).parent().parent().find('.type').val();
                var nextUl = $(this).next().children('ul');
                if (that.val().length > 0) {
                    $.ajax({
                        url: "/tags/getbiaotiapi/",
                        dataType: 'json',
                        type: 'GET',
                        delay: 1000,
                        data: {
                            key: that.val()
                        }, //查询参数*/
                        success: function (data) {
                            $(nextUl).html('')
                            var parsed = data.data;
                            var arr = [];
                            for (var x in parsed) {
                                var text = "<li>" + parsed[x].text + "</li>";
                                $(".tishi_box ul").append(text)
                            }
                        },
                        cache: true
                    })
                }
            });


            $(".datetime").datetimepicker({
                format: "yyyy-mm-dd",
                startView: 2,
                todayHighlight: 1,
                minView: 2,
                todayBtn: true,
                autoclose: true,
                startDate : new Date(),
            });

            //多选按钮
            $(".item li").click(function (event) {
                var _this = $(this);
                if (!_this.hasClass('active')) {
                    _this.addClass('active').siblings('li').removeClass('active');
                    _this.parent().parent().parent().siblings('.form-group').find('li').removeClass(
                        'active');
                } else {
                    _this.removeClass("active");
                }
            });


            //美图类型
            $("select[name=type]").change(function (event) {
                $(".master").hide();
                if ($(this).val() == 2) {
                    $(".master").show();
                }
            });
            //输入框值联动
            $('#bt-title').bind('input propertychange', function () {
                var datetime = new Date();
                var year = datetime.getFullYear();
                var x = $(this).val();
                $('#biaoti2').val(x);
                $('#biaoti3').val("齐装网装修效果图频道，提供" + year + "年" + x + "，定期更新上百套" + x +
                "，为您带来精彩的装修设计灵感。");
                if (x == "") {
                    $('#biaoti3').val("");
                } else {
                    return;
                }
            })



        })
    </script>
</block>
