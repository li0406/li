<extend name="Main:baseTemplate" />
<block name="title">
<title>美图首页管理 - 控制台</title>
</block>
<block name="style">
<style>
#b-nav li {color: #777;padding: 16px 15px;cursor: pointer;}
#b-nav li.active {color: #555;background-color: #e7e7e7;}
.listBox {width:100%; height:100%; background: rgba(0,0,0,0.8);position: fixed; left:0px;top:0px;  z-index: 99999; display: none;}
.win-box{width:98%; height:calc(100% - 40px); background: #fff; margin:20px auto;}
.win-head{overflow: hidden; border-bottom: 1px solid #DEDEDE; font-size:16px; padding:10px 0px; }
.win-head span{padding:3px 10px;display: inline-block; cursor: pointer;}
.win-body{padding:5px 10px; height:calc(100% - 105px);}
.chose-box{margin-bottom: 20px; display: none;}
</style>
    <link rel="stylesheet" type="text/css" href="/assets/common/plugins/fileinput/css/fileinput.min.css?v={:C('STATIC_VERSION')}" />
</block>

<block name="content">
    <section class="content-header">
        <nav class="navbar navbar-default" style="margin-bottom:0px;">
        <div class="container-fluid">
        <div class="navbar-header"><a class="navbar-brand" href="javascript:;">美图首页管理</a></div>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav" id="b-nav">
                    <li class="h4 no-margin">家装效果图</li>
                    <li class="h4 no-margin">公装效果图</li>
                    <li class="h4 no-margin">3D效果图</li>
                    <li class="h4 no-margin">装修风格推荐</li>
                </ul>
            </div>
        </div>
        </nav>
    </section>
    <section class="content">
        <div class="row">
            <!-- 家装效果图 -->
            <div class="col-xs-12" id="jiaz-box">
                <div class="box box-widget">
                    <div class="box-header with-border">
                        <div><h4 class="h4 no-margin">家装效果图</h4></div>
                        <div class="box-tools">
                            <button type="button" class="btn btn-success btn-sm selectBox" category_name="家装" category_id="">
                                <i class="fa fa-plus-circle"></i>&nbsp;选取
                            </button>
                        </div>
                    </div>
                    <div class="box-body">
                        <table class="table table-hover" >
                            <thead>
                                <tr style="font-size:14px;font-weight:normal;background:#F5F5F5">
                                    <th width="60">ID</th>
                                    <th style="text-align:left">标题</th>
                                    <th>关键字</th>
                                    <th>标签</th>
                                    <th width="120">操作人</th>
                                    <th width="180">发布时间</th>
                                </tr>
                            </thead>
                            <tbody id="pubmeitu-list">
                                <volist name="jiazhuanglist" id="vo">
                                    <tr>
                                        <td>{$vo.id}</td>
                                        <td style="text-align:left">
                                            <a href="http://{:C('QZ_YUMINGWWW')}/tu/j{$vo.id}.html" target="_blank">
                                                <!--<span class="label label-success"><i class="fa fa-clock-o"></i>预</span>-->
                                                {$vo.title}
                                            </a>
                                        </td>
                                        <td>{$vo.keyword}</td>
                                        <td></td>
                                        <td>{$vo.created_name}</td>
                                        <td>{$vo.publish_time|date='Y-m-d H:i:s',###}</td>
                                    </tr>
                                </volist>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- 公装效果图 -->
            <div class="col-xs-12" id="gongz-box" style="display: none;">
                <div class="box box-widget">
                    <div class="box-header with-border">
                        <div><h4 class="h4 no-margin">公装效果图</h4></div>
                        <div class="box-tools">
                            <button type="button" class="btn btn-success btn-sm selectBox" category_name="公装" category_id="">
                                <i class="fa fa-plus-circle"></i>&nbsp;选取
                            </button>
                        </div>
                    </div>
                    <div class="box-body">
                        <table class="table table-hover" >
                            <thead>
                                <tr style="font-size:14px;font-weight:normal;background:#F5F5F5">
                                    <th width="60">ID</th>
                                    <th style="text-align:left">标题</th>
                                    <th>关键字</th>
                                    <th>标签</th>
                                    <th width="120">操作人</th>
                                    <th width="180">发布时间</th>
                                </tr>
                            </thead>
                            <tbody id="pubmeitu-list">
                                <volist name="gongzhuanglist" id="vo">
                                    <tr>
                                        <td>{$vo.id}</td>
                                        <td style="text-align:left">
                                            <a href="http://{:C('QZ_YUMINGWWW')}/tu/g{$vo.id}.html" target="_blank">
                                                <!--<span class="label label-success"><i class="fa fa-clock-o"></i>预</span>-->
                                                {$vo.title}
                                            </a>
                                        </td>
                                        <td>{$vo.keyword}</td>
                                        <td></td>
                                        <td>{$vo.created_name}</td>
                                        <td>{$vo.publish_time|date='Y-m-d H:i:s',###}</td>
                                    </tr>
                                </volist>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- 3D效果图 -->
            <div class="col-xs-12" id="3d-box" style="display: none;">
                <div class="box box-widget">
                    <div class="box-header with-border">
                        <div><h4 class="h4 no-margin">3D效果图</h4></div>
                        <div class="box-tools">
                            <button type="button" class="btn btn-success btn-sm selectBox" category_name="3D" category_id="">
                                <i class="fa fa-plus-circle"></i>&nbsp;选取
                            </button>
                        </div>
                    </div>
                    <div class="box-body">
                        <table class="table table-hover" >
                            <thead>
                                <tr style="font-size:14px;font-weight:normal;background:#F5F5F5">
                                    <th width="60">ID</th>
                                    <th style="text-align:left">标题</th>
                                    <th width="120">操作人</th>
                                    <th width="180">发布时间</th>
                                </tr>
                            </thead>
                            <tbody id="pubmeitu-list">
                                <volist name="threedlist" id="vo">
                                    <tr>
                                        <td>{$vo.link_id}</td>
                                        <td style="text-align:left">
                                            <a href="http://{:C('QZ_YUMINGWWW')}/tu/3d-conten{$vo.link_id}.html" target="_blank">
<!--                                                <span class="label label-success"><i class="fa fa-clock-o"></i>预</span>-->
                                                {$vo.title}
                                            </a>
                                        </td>
                                        <td>{$vo.adminuser}</td>
                                        <td>{$vo.publish_time}</td>
                                    </tr>
                                </volist>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-xs-12" id="top-box" style="display: none;">
                <div class="box box-widget">
                    <div class="box-header with-border">
                        <div><h4 class="h4 no-margin">装修风格推荐</h4></div>
                    </div>
                    <div class="box-body">
                        <table class="table table-hover" >
                            <thead>
                            <tr style="font-size:14px;font-weight:normal;background:#F5F5F5">
                                <th width="200">图片</th>
                                <th width="300">标题</th>
                                <th>url</th>
                                <th>排序</th>
                                <th width="200">添加时间</th>
                                <th width="200">操作</th>
                            </tr>
                            </thead>
                            <tbody id="top-list">
                                <volist name="recommend" id="vo">
                                <tr >
                                    <td width="200">
                                        <img src="{$vo.thumb}"/>
                                    </td>
                                    <td width="300">{$vo.title}</td>
                                    <td><a href="{$vo.url}" target="_blank">{$vo.url}</a></td>
                                    <td>{$key+1}</td>
                                    <td width="100">{$vo.updated_at|date="Y-m-d",###}</td>
                                    <td width="100">
                                        <a href="javascript:void(0)" data-id="{$vo.id}" data-title="{$vo.title}" data-url="{$vo.url}" data-origin="{$vo.thumb_original}" data-thumb="{$vo.thumb}" class="edit">编辑</a>
                                    </td>
                                </tr>
                                </volist>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="listBox">
            <div class="win-box">
                <div class="win-head"><span class="pull-left win-title"></span></div>
                <div class="win-body" style="overflow-y:visible;">
                    <iframe src="" width="100%" height="100%" id="selectBox" frameborder="0" scrolling="yes"></iframe>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="module" name="module" value="">
                    <button type="button" class="btn btn-default pull-left hideLoading" id="cancel">取消</button>
                    <button type="button" class="btn btn-primary hideLoading" id="saveBtn">保存</button>
              </div>
            </div>
        </div>
    </section>
    <div class="modal fade">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">风格推荐详情</h4>
                </div>
                <div class="modal-body">
                    <form id="myform" class="form-horizontal">
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label">标题：</label>
                            <div class="col-sm-10">
                                <input name="title" type="text" class="form-control" placeholder="标题" maxlength="10">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label">url：</label>
                            <div class="col-sm-10">
                                <input name="url" type="text" class="form-control"  placeholder="url">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="inputEmail3" class="col-sm-2 control-label">图片：</label>
                            <div class="col-sm-10">
                                <input id="fileinput" type="file">
                                <input type="hidden" name="img"/>
                                <input type="hidden" name="id"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-sm-10 col-sm-offset-2">
                                <div class="alert alert-warning" role="alert">建议图片尺寸：389*236</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button id="btnSave" type="button" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

</block>
<block name="script">
<script src="/assets/common/js/plugins/bootstrapswitch/bootstrap-switch.min.js?v={:C('STATIC_VERSION')}"></script>
<script src="/assets/common/js/js.cookie.js?v={:C('STATIC_VERSION')}"></script>

    <script type="text/javascript" src="/assets/common/plugins/fileinput/js/fileinput.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript" src="/assets/common/plugins/fileinput/js/fileinput_locale_zh.js?v={:C('STATIC_VERSION')}"></script>
<script type="text/javascript">
$(document).ready(function(){
    <volist name="modulelist" id="v">
    if('{$v.module}' == 'meituv2-1'){
        Cookies.set('{$v.module}',JSON.stringify([<volist name="jiazhuanglist" id="vs">"{$vs.id}",</volist>]));
    }else if('{$v.module}' == 'pubmeitu-2'){
        Cookies.set('{$v.module}',JSON.stringify([<volist name="gongzhuanglist" id="vs">"{$vs.id}",</volist>]));
    }else if('{$v.module}' == '3dmeitu-3'){
        Cookies.set('{$v.module}',JSON.stringify([<volist name="threedlist" id="vs">"{$vs.link_id}",</volist>]));
    }
    </volist>
});
</script>

<script type="text/javascript">

$(document).ready(function(){
    var tab = sessionStorage.getItem("tabIndex");
    if (tab == null) {
        tab = 0;
    }

    // 切换导航栏
    $('.navbar-nav').on('click','li',function(i){
        $("#b-nav .active").removeClass("active");
        $("#b-nav li").eq($(this).index()).addClass("active");

        if ($(this).index() == 0) {
            $("#jiaz-box").show();
            $("#gongz-box").hide();
            $("#3d-box").hide();
            $("#top-box").hide();
        } else if ( $(this).index() == 1){
            $("#jiaz-box").hide();
            $("#gongz-box").show();
            $("#3d-box").hide();
            $("#top-box").hide();
        } else if ( $(this).index() == 2){
            $("#jiaz-box").hide();
            $("#gongz-box").hide();
            $("#3d-box").show();
            $("#top-box").hide();
        } else if ( $(this).index() == 3){
            $("#jiaz-box").hide();
            $("#gongz-box").hide();
            $("#3d-box").hide();
            $("#top-box").show();
        };
        sessionStorage.setItem("tabIndex",$(this).index());
    });
    $('.navbar-nav li').eq(tab).trigger("click");

    // 选取
    $('.selectBox').click(function(event){
        var name = $(this).attr('category_name');
        var id = $(this).attr('category_id');

        $(".listBox").fadeIn();
        $(".win-title").text('选取'+name+'美图');
        if (name == '家装') {
            $('#module').val('meituv2-1');
            $("#selectBox",parent.document.body).attr("src","/meituv2/meitubox");
        }else if (name == '公装') {
            $('#module').val('pubmeitu-2');
            $("#selectBox",parent.document.body).attr("src","/meituv2/gzbox");
        } else {
            $('#module').val('3dmeitu-3');
            $("#selectBox",parent.document.body).attr("src","/meituv2/threebox");
        }
    });

    //保存选择
    $('#saveBtn').click(function(){
        var module = $('#module').val();
        $.ajax({
            url: '/meituv2/saveMeituHomeData',
            type: 'GET',
            dataType: 'JSON',
            data:{
                module:module
            }
        })
        .done(function(data) {
            if(data.status == 1){
                $('#'+module+'-list').html('');
                $.each(data.data, function(idx,o) {
                    $('#'+module+'-list').append('<tr><td>'+o.id+'</td><td>'+o.title+'</td><td>'+o.keyword+'</td><td>'+o.uname+'</td><td>'+o.times+'</td></tr>');
                });
            }else{
                if(data.error_code == 1){
                    alert(data.error_msg);
                    history.go(0);
                }else{
                    alert(data.error_msg);
                }
            }
        })
        .fail(function(xhr) {
            alert('操作失败,网络错误！');
        })
    });

    $('#cancel').click(function(){
        $(".listBox").fadeOut();
    });

    $(".edit").click(function(){
        var title = $(this).attr("data-title");
        var url = $(this).attr("data-url");
        var thumb = $(this).attr("data-thumb");
        var id = $(this).attr("data-id");
        var origin = $(this).attr("data-origin");
        $(".modal").on("show.bs.modal",function(){
            $("[name=title]", $("#myform")).val(title);
            $("[name=url]", $("#myform")).val(url);
            $("[name=id]", $("#myform")).val(id);
            $("[name=img]", $("#myform")).val(origin);
            $('#fileinput').fileinput('refresh',{
                initialPreview:["<img src='"+thumb+"'/>"],
            });
        }).modal();
    });

    $("#fileinput").fileinput({
        language: 'zh', //设置语言,
        uploadUrl:"/upload/uploadImg",
        showCaption:false,
        browseClass:"btn btn-primary",
        allowedFileExtensions : ['jpg','png','gif'],
        maxFileCount:1,
        uploadClass:"btn btn-info",
        removeClass:"btn btn-danger",
        uploadAsync:true,
        dropZoneEnabled:false,
        previewSettings:{
            image: {width: "200px", height: "200px"}
        },
        uploadExtraData:{
            prefix:"custom"
        },

    }).on('fileuploaded', function(event, data) {
        if(data.response.status == 1){
            var data = data.response.data;
            $("[name=img]",$("#myform")).val(data.name)
        }else{
            alert(data.response.info);
        }
    }).on("fileuploaderror",function(event, data){
        var _this = $(this);
        alert("上传失败");
        return false;
    }).on("fileclear",function(){
        $("input[name=img]").val("");
    });

    $("#btnSave").click(function(){
        if (confirm("确认保存图片信息")) {
            if ($("[name=title]", $("#myform")).val() == "") {
                alert("请输入标题");
                return;
            }
            if ($("[name=url]", $("#myform")).val() == "") {
                alert("请输入完整url");
                return;
            }

            if ($("[name=img]", $("#myform")).val() == "") {
                alert("请先上传图片");
                return;
            }

            $.ajax({
                url: '/meituv2/recommentUp',
                type: 'POST',
                dataType: 'json',
                data: $("#myform").serializeArray()
            })
                .done(function (data) {
                    if (data.error_code == 1) {
                        alert(data.error_msg);
                        window.location.href = window.location.href;
                    } else {
                        alert(data.error_msg);
                    }
                });
        }
    });
})
</script>
</block>
