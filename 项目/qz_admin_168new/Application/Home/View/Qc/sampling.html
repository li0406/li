<extend name="Main:baseTemplate" />
<block name="title">
    <title>质检抽检管理-控制台</title>
</block>
<block name="style">
<link rel="stylesheet" type="text/css" href="/assets/common/css/select2_metro.css?v={:C('STATIC_VERSION')}" />
<link rel="stylesheet" type="text/css" href="/assets/common/js/plugins/datetimepicker/datepicker.css?v={:C('STATIC_VERSION')}" />
<link rel="stylesheet" href="/assets/home/order/css/index.css?v={:C('STATIC_VERSION')}">
<link rel="stylesheet" type="text/css" href="/assets/home/css/qc.css?v={:C('STATIC_VERSION')}" />
<link rel="stylesheet" href="/assets/home/orders/css/modifyriz.css?v={:C('STATIC_VERSION')}">
<style>
    .cols{position: relative;}
    .cols .eyes{margin-left:20px;cursor: pointer;position: absolute;}
    .cols .eyes i.eyeColor{color:#2196F3 !important;position: relative;}
    .cols .eyes i:hover.eyeColor .untreated{display: block; width: 130px; height: 30px; line-height: 30px;background: #fff;border: 1px solid #ccc;position: absolute;top: 15px;left: -15px;color: #666;border-radius: 4px;z-index: 999;}
    .cols .eyes i .untreated{display: none;}
    .cols .eyes i.ycl {position: relative;}
    .cols .eyes i:hover.ycl .processed{display: block; width: 130px; height: 30px; line-height: 30px;background: #fff;border: 1px solid #ccc;position: absolute;top: 15px;left: -15px;color: #666;border-radius: 4px;z-index: 999;}
    .cols .eyes i .processed{display: none;}
    .mask{width:100%;height:100%;position: fixed;top:0;left: 0;background: rgba(0, 0, 0, .5);}
    .mask .inner{width:60%;height:auto;background:#fff;position: absolute;left:50%;top:50%;margin-left:-30%;margin-top:-150px;}
    .mask .inner h4{font-size:16px;padding: 10px 20px ;}
    .mask .inner .tableList{padding:30px 30px 10px;border-top: 1px solid #ccc;border-bottom: 1px solid #ccc;}
    .mask .inner table  tr{border:1px solid #ccc}
    .mask .inner table thead tr th{border:1px solid #ccc}
    .mask .inner table tbody tr td{border:1px solid #ccc}
    .mask .inner .liyou{width:25%}
    .mask .inner .time{width:15%}
    .mask .inner .close_top{float: right; padding-right: 10px; cursor: pointer;}
    .mask .inner .red{color:red}
    .mask .inner .blue{color:#2196F3}
</style>
</block>
<block name="content">
    <section class="content-header">
        <h1>质检抽检管理</h1>
    </section>
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-default">
                    <div class="box-header font-12">
                        <form action="/qc/sampling/" method="get">
                            <div class="row">
                                <div class="col-xs-1">
                                    <p>质检员:</p>
                                    <select class="select2 select2-offscree " name="op_uid" type="text" placeholder="质检员" tabindex="-1">
                                        <option value="">请选择</option>
                                        <volist name="qcList" id="vo">
                                            <option value="{$vo.id}">{$vo.name}</option>
                                        </volist>
                                    </select>
                                </div>
                                <div class="col-xs-1">
                                    <p>订单类型:</p>
                                    <select class="select2 select2-offscree " name="orders_type" type="text" placeholder="订单类型" tabindex="-1">
                                        <option value="">请选择</option>
                                        <option value="1">分单</option>
                                        <option value="2">赠单</option>
                                        <option value="3">次新单</option>
                                        <option value="4">扫单</option>
                                        <option value="5">待定单</option>
                                        <option value="6">无效单</option>
                                    </select>
                                </div>
                                <div class="col-xs-1">
                                    <p>抽检状态:</p>
                                    <select class="select2 select2-offscree " name="status" type="text" placeholder="抽检状态" tabindex="-1">
                                        <option value="">请选择</option>
                                        <option value="2">已抽检</option>
                                        <option value="">未抽检</option>
                                    </select>
                                </div>
                                <div class="col-xs-1">
                                    <p>城市:</p>
                                    <select class="select2 select2-offscree " name="orders_cs" type="text" placeholder="城市" tabindex="-1">
                                        <option value="">请选择</option>
                                        <volist name="city" id="vo">
                                            <option value="{$vo.cid}">{$vo.cname}</option>
                                        </volist>
                                    </select>
                                </div>
                                <div class="col-xs-2">
                                    <p>订单编号：</p>
                                    <input class="form-control" type="text" name="orders_id" placeholder="订单编号" value="{$Think.get.orders_id}">
                                </div>
                                <div class="col-xs-1">
                                    <p>客服师:</p>
                                    <select class="select2 select2-offscree " name="kf_manager" type="text" placeholder="城市" tabindex="-1">
                                        <option value="">请选择</option>
                                        <volist name="manager" id="vo">
                                            <option value="{$vo.id}">{$vo.name}</option>
                                        </volist>
                                    </select>
                                </div>
                                <div class="col-xs-1">
                                    <p>客服团:</p>
                                    <select class="select2 select2-offscree " name="kf_group" type="text" placeholder="城市" tabindex="-1">
                                        <option value="">请选择</option>
                                        <volist name="groups" id="vo">
                                            <option value="{$vo.kfgroup}">{$vo.name}</option>
                                        </volist>
                                    </select>
                                </div>
                                <div class="col-xs-1">
                                    <p>客服人员:</p>
                                    <select class="select2 select2-offscree " name="kf_id" type="text" placeholder="城市" tabindex="-1">
                                        <option value="">请选择</option>
                                        <volist name="kfList" id="vo">
                                            <option value="{$vo.id}">{$vo.name}</option>
                                        </volist>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-1">
                                    <p>实际发布时间:</p>
                                    <input class="form-control datepicker" type="text" name="orders_time_real_start" placeholder="订单实际发布开始时间" value="{$Think.get.orders_time_real_start}">
                                </div>
                                <div class="col-xs-1">
                                    <p>&nbsp;</p>
                                    <input class="form-control datepicker" type="text" name="orders_time_real_end" placeholder="订单实际发布结束时间" value="{$Think.get.orders_time_real_end}">
                                </div>
                                <div class="col-xs-1">
                                    <p>质检时间:</p>
                                    <input class="form-control datepicker" type="text" name="time_start" placeholder="质检开始时间" value="{$Think.get.time_start}">
                                </div>
                                <div class="col-xs-1">
                                    <p>&nbsp;</p>
                                    <input class="form-control datepicker" type="text" name="time_end" placeholder="质检结束时间" value="{$Think.get.time_end}">
                                </div>
                                <div class="col-xs-1">
                                    <p>抽检时间:</p>
                                    <input class="form-control datepicker" type="text" name="sampling_start" placeholder="抽检开始时间" value="{$Think.get.sampling_start}">
                                </div>
                                <div class="col-xs-1">
                                    <p>&nbsp;</p>
                                    <input class="form-control datepicker" type="text" name="sampling_end" placeholder="抽检结束时间" value="{$Think.get.sampling_end}">
                                </div>
                                <div class="col-xs-1">
                                   <p>&nbsp;</p>
                                   <button id="btnSearch" type="submit" class="btn btn-primary btn-sm btn-flat  ml10"><i class="fa fa-search"></i>&nbsp;搜索</button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="box-body">
                        <table class="table table-hover table-bordered ">
                            <thead>
                                <tr>
                                    <th>序号</th>
                                    <th>订单发布时间</th>
                                    <th>订单质检时间</th>
                                    <th>订单号</th>
                                    <th>订单类型</th>
                                    <th>客服</th>
                                    <th>质检员</th>
                                    <th>质检状态</th>
                                    <th>抽检时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <volist name="list" id="vo" key="key">
                                <tr>
                                    <td>{$key}</td>
                                    <td>{$vo.time_real|date="Y-m-d H:i:s",###}</td>
                                    <td>{$vo.qc_time|date="Y-m-d H:i:s",###}</td>
                                    <td class="cols">
                                        {$vo.id}
                                        <span class="eyes" data-id="{$vo.id}">
                                            <switch name="vo.apply_mark">
                                            <case value="1">
                                                <i class="fa fa-eye text-gray eyeColor" >
                                                    <span class="untreated">已处理显号审核</span>
                                                </i>
                                            </case>
                                            </switch>
                                        </span>
                                    </td>
                                    <td>
                                        <if condition="$vo['on'] EQ 4 and $vo['type_fw'] EQ 1">
                                        分单
                                        <elseif condition="$vo['on'] EQ 4 and $vo['type_fw'] EQ 2"/>
                                        赠单
                                        <elseif condition="$vo['on'] EQ 0 and $vo['type_fw'] EQ 9"/>
                                        次新单
                                        <elseif condition="$vo['on'] EQ 5"/>
                                        无效单
                                        <elseif condition="$vo['on'] EQ 2"/>
                                        待定单
                                        <else/>
                                        扫单
                                        </if>
                                    </td>
                                    <td>
                                        <if condition="($vo['ustate'] EQ 0) OR ($vo['uuid'] EQ 84)">
                                            <span style="color:#FF6600;">{$vo.chk_name|default="-"}</span>
                                            <else/>
                                            <span>{$vo.chk_name|default="-"}</span>
                                        </if>

                                        </td>

                                    <td>{$vo.op_name|default="-"}</td>
                                    <td>
                                        已质检
                                        <if condition="$vo['state'] EQ 2 AND $vo['sampling_status'] EQ 2">
                                        <i class="fa fa-check" title="已抽检合格"></i>
                                        <elseif condition="$vo['state'] EQ 2 AND $vo['sampling_status'] EQ 1"/>
                                        <i class="fa fa-times" title="已抽检未合格"></i>
                                        </if>
                                        <if condition="$vo['tel_status'] EQ 1 AND $vo['tel_type'] EQ 1">
                                        <i class="fa fa-gratipay" title="优秀录音"></i>
                                        <elseif condition="$vo['tel_status'] EQ 1 AND $vo['tel_type'] EQ 2" />
                                        <i class="fa fa-question-circle" title="问题录音"></i>
                                        </if>
                                    </td>
                                    <td>{$vo.sampling_time}</td>
                                    <td>
                                        <a href="javascript:void(0)" class="icheck" data-href="/qc/samplinginfo?id={$vo.id}" data-backdrop="false">抽检</a>
                                    </td>
                                </tr>
                                </volist>
                            </tbody>
                        </table>
                        {$show}
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="myModal" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog modal-lg" role="document" style="width: 1520px; margin-top: 10px;">
                <div class="modal-content">
                    <div class="modal-header" style="padding:5px;">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title text-center">质检评分</h4>
                    </div>
                    <div class="modal-body no-padding">
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div class="modal fade common-model" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
                    </button>
                    <h4 class="modal-title">记录列表</h4>
                </div>
                <div class="modal-body common-model-content"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    <div class="mask">
        <div class="inner">
            <h4>申请记录列表<span class="close_top">X</span></h4>
            <div class="tableList">
                <table class="table table-hover table-bordered ">
                    <thead>
                    <tr>
                        <th class="time">申请时间</th>
                        <th>申请人</th>
                        <th class="liyou">申请理由</th>
                        <th>申请入口</th>
                        <th class="time">审核时间</th>
                        <th>审核人</th>
                        <th>审核结果</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id="giveUp">关闭</button>
            </div>
        </div>
    </div>
</block>
<block name="script">
<script type="text/javascript" src="/assets/common/js/select2.min.js?v={:C('STATIC_VERSION')}"></script>
<script type="text/javascript" src="/assets/common/js/plugins/datetimepicker/bootstrap-datepicker.js?v={:C('STATIC_VERSION')}"></script>
<script type="text/javascript">
    $(function(){
        $("select[name=orders_cs]").select2();
        $("select[name=orders_cs]").select2("val","{$Think.get.orders_cs}");

        $("select[name=kf_manager]").select2();
        $("select[name=kf_manager]").select2("val","{$Think.get.kf_manager}");

        $("select[name=kf_group]").select2();
        $("select[name=kf_group]").select2("val","{$Think.get.kf_group}");

        $("select[name=kf_id]").select2();
        $("select[name=kf_id]").select2("val","{$Think.get.kf_id}");

        $("select[name=orders_type]").select2();
        $("select[name=orders_type]").select2("val","{$Think.get.orders_type}");

        $(".datepicker").datepicker({
            format:"yyyy-mm-dd"
        });
        $("select[name=status]").select2();
        $("select[name=status]").select2("val","{$Think.get.status}");

        $("select[name=op_uid]").select2();
        $("select[name=op_uid]").select2("val","{$Think.get.op_uid}");

        $(".icheck").click(function(event) {
            $("#myModal .modal-body").load($(this).attr("data-href")+"&rand="+new Date().getTime(),function(){
                $("#myModal").modal("show").on("shown.bs.modal",function(){
                    isLoading = false;
                    $.ajax({
                        url: '/voip/voiprecord/',
                        type: 'GET',
                        dataType: 'JSON',
                        data: {
                            id: $("input[name=orderid]").val(),
                            type:'qc'
                        }
                    })
                    .done(function(data) {
                        if (data.status == '1') {
                            $("#video").html(data.data);
                        }
                    });
                    $("input[name='item[]']:checked").each(function(){
                        $(this).parents(".checkbox").next(".radiobox").css("visibility","visible");
                    });

                    $("input[name='qcservice[]']:checked").each(function(){
                        $(this).parents(".checkbox").next(".radiobox-service").css("visibility","visible");
                    });
                });
            })
        });

        $("body").on("click","input[name=sampling_status]",function(){
            $(this).parents("dt").next(".qc-item").hide();
            if ($(this).val() == 1) {
                $(this).parents("dt").next(".qc-item").show();
            }
        });

        $("body").on("click","#btnSave",function(){
            var data = $("#samplingForm").serializeArray();
            data.push({name:"id",value:$("input[name=orderid]").val()});
            data.push({name:"qcid",value:$("input[name=qcid]").val()});
            $.ajax({
                url: '/qc/samplingup/',
                type: 'POST',
                dataType: 'JSON',
                data: data
            })
            .done(function(data) {
                if (data.status == 1) {
                    $("#myModal").modal("hide");
                } else {
                    alert(data.info);
                }
            });
        });

        $("body").on("click","#btnReset",function(){
            if (confirm("确定撤销吗？")) {
                var data = $("#samplingForm").serializeArray();
                data.push({name:"id",value:$("input[name=orderid]").val()});
                data.push({name:"qcid",value:$("input[name=qcid]").val()});
                $.ajax({
                    url: '/qc/qcreset/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: data
                })
                .done(function(data) {
                    alert(data.info);
                    $("#myModal").modal("hide");
                });
            }
        });

        $('body').on("click",".modifyrizhi", function(){
            var _this = $(this);
            $.ajax({
                url: '/orders/getorderfieldstat',
                type: 'POST',
                dataType: 'JSON',
                data: {id: _this.attr("data-id")}
            })
            .done(function(data) {
                if (data.status == 1) {
                    _this.parents(".qc-group").append(data.data)
                } else {
                    alert(data.info);
                }
            });
        });

        /*S-手机号重复订单*/

        $('body').on("click",".phone-repeat-order", function() {
            var id = $(this).attr('data-id');
            var _this = $(this);
            $.ajax({
                url: '/qc/getrepeatorderlistbyphone/',
                type: 'POST',
                dataType: 'JSON',
                data: {
                    id: id
                }
            })
                    .done(function(data) {
                        if (data.status == '1') {
                            $('.common-model-content').empty();
                            $('.common-model-content').html(data.data);
                            $('.common-model').modal('show');
                        } else {
                            var e = dialog({
                                title: '消息',
                                content: data.info,
                                okValue: '确 定',
                                quickClose: true,
                                ok: function() {}
                            });
                            e.show();
                            return false;
                        }
                    })
                    .fail(function(xhr) {
                        var e = dialog({
                            title: '消息',
                            content: '发生未知错误，请联系技术部门~',
                            okValue: '确 定',
                            quickClose: true,
                            ok: function() {}
                        });
                        e.show();
                        return false;
                    })
        });
        /*E-手机号重复订单*/
        //关闭
        $(".close_top").on("click",function(){
            $(".mask").hide();
        })

        $("#giveUp").on("click",function(){
            $(".mask").hide();
        })
    });
</script>
</block>
