<!--广告位置设置-->

<extend name="Main:baseTemplate"/>
<block name="style">
    <link rel="stylesheet"
          href="/assets/common/js/plugins/select2/select2.min.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="/assets/common/plugins/layer/layer.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="/assets/home/adposition/css/adposlist.css?v={:C('STATIC_VERSION')}">
    <style>


        .img-box {
            border: 1px solid #E5E5E5;
            padding: 15px;
            margin-top: 20px;
        }

        .img-box img {
            width: 100%;
        }
        .modal{
            top: -180px;
        }
        .ad-name{
            text-indent: 5px;
        }
        .file-preview{
            width: 91%;
            position: relative;
            left: -203px;
        }
        .change-btn{
            /*float: right;*/
            /*margin-right: 78px;*/
        }
        .fileinput-upload{
            position: relative;
            left: -208px;
        }
        .kv-upload-progress{
            position: relative;
            left: -200px;
        }
        .modal-dialog{
            max-width: 1400px;
            max-height: 800px;
        }
    </style>
</block>
<block name="content">
    <section class="content-header">
        <h1>广告位设置</h1>
        <ol class="breadcrumb">
            <li><a href="/"><i class="fa fa-dashboard"></i> 控制面板</a></li>
            <li><a href="advposition/position">广告位设置</a></li>
        </ol>
    </section>
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-default">
                    <div class="box-body ad-set">
                        <div class="row col-xs-7 reset-padding">
                            <div class="col-xs-12 mb10">
                                <p class="col-xs-5 position-title">广告位设置</p>
                                <div class="col-xs-5 pull-right clearfix " style="padding-left: 30px;">
                                    <empty name="info.id">
                                        <button class="col-xs-4 confirm-btn btn btn-success mr10">确认添加</button>
                                        <button class="col-xs-4 giveup-add change-btn btn mr10">放弃添加</button>
                                    <else />
                                        <button class="col-xs-4 confirm-btn btn btn-success mr10">确认修改</button>
                                        <button class="col-xs-4 unChange-btn change-btn btn mr10" data-id="{$info.id}">放弃修改</button>
                                    </empty>
                                </div>
                            </div>
                            <form class="form-horizontal">
                                <div class="col-xs-10 item-box">
                                    <notempty name="info.id">
                                        <div class="col-xs-12 mb15">
                                            <span class="col-xs-2 sub-item reset-padding">广告位id：</span>
                                            <span class="col-xs-5 reset-padding item-show">{:sprintf("%06d", $info["id"])}</span>
                                        </div>
                                    </notempty>

                                    <div class="col-xs-12 mb15">
                                        <span class="col-xs-2 sub-item reset-padding"><i>*</i>广告位名称：</span>
                                        <input class="col-xs-9 reset-padding ad-name input-select" type="text"
                                               placeholder="请输入广告位名称"
                                               maxlength="20"
                                               value="{$info.name}">
                                    </div>
                                    <div class="col-xs-12 mb15">
                                        <span class="col-xs-2 sub-item reset-padding"><i>*</i>广告位置：</span>
                                        <select name="platform_id"
                                                class="col-xs-2 platform-name input-select reset-padding mr21">
                                            <option value="">选择平台</option>
                                            <volist name="platform_list" id="item">
                                                <option value="{$item.id}"
                                                <eq name="info.platform_id" value="$item['id']">selected</eq>
                                                >{$item.name}</option>
                                            </volist>
                                        </select>
                                        <select name="module_id"
                                                class="col-xs-2 modal-name input-select reset-padding mr21">
                                            <option value="">选择模块</option>
                                            <volist name="module_list" id="item">
                                                <option value="{$item.id}"
                                                <eq name="info.module_id" value="$item['id']">selected</eq>
                                                >{$item.name}</option>
                                            </volist>
                                        </select>
                                        <select name="page_id"
                                                class="col-xs-2 page-name input-select reset-padding mr21">
                                            <option value="">选择页面</option>
                                            <volist name="page_list" id="item">
                                                <option value="{$item.id}"
                                                <eq name="info.page_id" value="$item['id']">selected</eq>
                                                >{$item.name}</option>
                                            </volist>
                                        </select>
                                        <select name="position_id"
                                                class="col-xs-2 position-name input-select reset-padding mr21 ">
                                            <option value="">选择位置</option>
                                            <volist name="position_list" id="item">
                                                <option value="{$item.id}"
                                                <eq name="info.position_id" value="$item['id']">selected</eq>
                                                >{$item.name}</option>
                                            </volist>
                                        </select>
                                    </div>
                                    <div class="col-xs-12 mb15">
                                        <span class="col-xs-2 sub-item reset-padding"><i>*</i>广告样式：</span>
                                        <div class="col-xs-9">
                                            <label for="singlePic" class="temp-check mr10">
                                                <input type="radio" name="adStyle" value="1" id="singlePic"
                                                <eq name="info.type" value="1">checked</eq>
                                                >单图
                                            </label>
                                            <label for="multPic" class="temp-check mr10">
                                                <input type="radio" name="adStyle" value="2" id="multPic"
                                                <eq name="info.type" value="2">checked</eq>
                                                >多图
                                            </label>
                                            <label for="swipper" class="temp-check mr10">
                                                <input type="radio" name="adStyle" value="3" id="swipper"
                                                <eq name="info.type" value="3">checked</eq>
                                                >轮播
                                            </label>
                                            <label for="singleW" class="temp-check mr10">
                                                <input type="radio" name="adStyle" value="4" id="singleW"
                                                <eq name="info.type" value="4">checked</eq>
                                                >单图文
                                            </label>
                                            <label for="multW" class="temp-check mr10">
                                                <input type="radio" name="adStyle" value="5" id="multW"
                                                <eq name="info.type" value="5">checked</eq>
                                                >多图文
                                            </label>
                                            <label for="jsBanner" class="temp-check mr10">
                                                <input type="radio" name="adStyle" value="6" id="jsBanner"
                                                <eq name="info.type" value="6">checked</eq>
                                                >JS广告
                                            </label>
                                            <label for="tjsBanner" class="temp-check mr10">
                                                <input type="radio" name="adStyle" value="7" id="tjsBanner"
                                                <eq name="info.type" value="7">checked</eq>
                                                >双排JS广告
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-xs-12 mb15">
                                        <span class="col-xs-2 sub-item reset-padding"><i>*</i>广告要求：</span>
                                        <textarea class="col-xs-8 ad-request"
                                                  placeholder="一张图片，格式 png、jpg、jpeg，尺寸大于：730*230px，宽高比：4:3，大小500KB以内">{$info.demand}</textarea>
                                    </div>
                                    <div class="col-xs-12 mb15">
                                        <span class="col-xs-2 sub-item reset-padding"><i>*</i>状态：</span>
                                        <div class="col-xs-6">
                                            <label for="use" class="temp-check">
                                                <input type="radio" id="use" name="using" value="1"
                                                <eq name="info.enabled" value="1">checked</eq>
                                                >启用
                                            </label>
                                            <label for="stop" class="temp-check">
                                                <input type="radio" id="stop" name="using" value="2"
                                                <eq name="info.enabled" value="2">checked</eq>
                                                >停用
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="col-xs-5 reset-padding">
                            <div class="col-xs-12 reset-padding" style="position: relative;">
                                <span class="col-xs-5 pull-left view-position">位置预览</span>
                                <button type="button" class="btn btn-success view-bigImg col-xs-2 mr10"
                                        data-img="{$info.preview}">查看大图
                                </button>
                                <!--<button type="button" class="btn uploadView col-xs-4 mr10">上传预览图</button>-->
                                <div class="col-xs-3">
                                    <input id="imgUpload" type="file" name="img_upload" value="上传预览图"/>
                                    <input type="hidden" name="img_url" value="{$info.preview}"/>
                                </div>
                            </div>

                            <if condition="$info['id'] and $info['preview']">
                                <div class="col-xs-12 edit-img">
                                    <div class="col-xs-10 img-box">
                                        <img src="//{:C('QINIU_DOMAIN')}/{$info.preview}" alt="">
                                    </div>
                                </div>
                            </if>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         style="padding:11%;">
        <div class="modal-dialog " id="fix_dialog_width" style="overflow-y:auto;">
            <div class="modal-content">
                <div class="modal-body"><img src="" id="Preview" style="display: block; margin: 0 auto;"></div>
            </div>
        </div>
    </div>
</block>
<block name="script">
    <script src="/assets/common/plugins/layer/layer.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var typePlaceholder = {
                "1": "一张图片，格式 png、jpg、jpeg，尺寸大于：730*230px，宽高比：4:3，大小500KB以内",
                "2": "图片要求：3张图片，图片格式 png、jpg、jpeg，尺寸大于：230*230px，宽高比：1:1，500KB以内",
                "3": "图片要求：单张图片，图片格式 png、jpg、jpeg，尺寸大于：750*230px，宽高比：4:3，500KB以内；",
                "4": "标题要求：20个字符以内图片要求：单张图片，图片格式 png、jpg、jpeg，尺寸大于：750*230px，宽高比：4:3，500KB以内；",
                "5": "标题要求：20个字符以内。图片要求：单张图片，图片格式 png、jpg、jpeg，尺寸大于230*230px，宽高比：1:1，500KB以内；",
                "6": "请添加合适的JS代码",
                "7": "请添加合适的JS代码"
            };

            if ($(".ad-request").val() == "") {
                $(".ad-request").val(typePlaceholder["{$info.type}"]);
            }

            $("input:radio[name='adStyle']").on('click', function () {
                var checkeVal = $(this).val();
                var text = typePlaceholder[checkeVal];
                $(".ad-request").val(text);
            });

            // 获取平台-模块-页面-位置联动数据
            function getPositionOptionChildren(id, tip, callback) {
                var html = '<option value="">' + tip + '</option>';

                if (id == "") {
                    callback(html);
                    return;
                }

                // 数据请求
                $.get("/advposition/get_adv_position_option", {id: id}, function (result) {
                    if (result.status == 1) {
                        var list = result.data;
                        for (var i in list) {
                            html += '<option value="' + list[i]["id"] + '">' + list[i]["name"] + '</option>';
                        }

                        callback(html);
                    }
                });
            }

            // 平台选择
            $(".platform-name").on("change", function () {
                var id = $(this).val();
                getPositionOptionChildren(id, "选择模块", function (optionHtml) {
                    $(".modal-name").html(optionHtml);
                    $(".page-name").html('<option value="">选择页面</option>');
                    $(".position-name").html('<option value="">选择位置</option>');
                });
            });

            // 模块选择
            $(".modal-name").on("change", function () {
                var id = $(this).val();
                getPositionOptionChildren(id, "选择页面", function (optionHtml) {
                    $(".page-name").html(optionHtml);
                    $(".position-name").html('<option value="">选择位置</option>');
                });
            });

            // 页面选择
            $(".page-name").on("change", function () {
                var id = $(this).val();
                getPositionOptionChildren(id, "选择位置", function (optionHtml) {
                    $(".position-name").html(optionHtml);
                });
            });

            var imgUpload = $("#imgUpload").fileinput({
                language: 'zh', //设置语言,
                uploadUrl: "/upload/uploadimg/",
                showCaption: false,
                browseClass: "btn blue",
                allowedFileExtensions: ['jpg', 'png', 'jpeg'],
                maxFileCount: 1,
                autoReplace: true,
                showRemove: false,
                uploadClass: "btn green",
                removeClass: "btn red",
                uploadAsync: true,
                browseLabel: '上传预览图片',
                dropZoneEnabled: false,
                previewFileType: ['image'],
                progressDelay:10000,
                queueDelay:10,
                processDelay:0,
                previewSettings: {
                    image: {width: "auto", height: "100px"}
                },
                // minImageHeight: 230, //最小高度
                /* minImageWidth: 1205,
                 minImageHeight: 405,
                 maxImageWidth: 1205,
                 maxImageHeight: 405,*/
                maxFileSize: 50000,//	单位为kb，上传文件的最大值
                msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！",
                layoutTemplates: {
                    actionDelete: "",
                    actionUpload: ""
                },
                uploadExtraData: {
                    prefix: 'gg_img'
                },
                initialPreview: "{$leave.files|default=''}",
            })
            .on('filebatchselected', function (event, files) {
                $('.edit-img').hide()
                $('.file-input').addClass('file-img')
                $('.btn-file').addClass('file-slect-btn select-btn')
                $('.fileinput-remove-button').remove()
                $('.fileinput-upload-button').show()
            })
            .on('fileuploaded', function (event, data) {
                if (1 == data.response.status) {
                    $('.file-preview-thumbnails').children().hide()
                    $('.file-drop-disabled').append('  <img src="//{:C(\'QINIU_DOMAIN\')}/' + data.response.data.name + '" alt="" class="result-img">')
                    $('input[name=img_url]').val(data.response.data.name);
                    $('.view-bigImg').attr('data-img', data.response.data.name)
                    $('.fileinput-upload-button').hide()
                    $('.kv-upload-progress').hide()
                    $('#imgUpload').prop('disabled', true)
                } else {
                    alert("上传失败，请重新上传，如多次失败请联系技术部门");
                }
            })
            .on("fileuploaderror", function (event, data) {
                alert('附件上传失败,请联系技术部门！');
                $('.fileinput-upload-button').hide()
                return false;
            })
            .on("fileclear", function () {
                $('.file-preview-thumbnails').children().remove()
                $('.file-drop-disabled .result-img').remove()
                $('#imgUpload').prop('disabled', false)
                $('.file-input').removeClass('file-img')
                $('.btn-file').removeClass('select-btn')
                $('.fileinput-upload-button').hide()
                $("input[name=img_url]").val("");
                $('.edit-img').show()
            })
            .on('filebatchuploadcomplete', function () {
                $('#imgUpload').prop('disabled', true)
            });

            $('.view-bigImg').on('click', function () {
                var imgUrl = $("input[name=img_url]").val();
                var imgUrl_1 = $('.view-bigImg').data('img');

                if (imgUrl) {
                    var imgUrlFull = "//{:C('QINIU_DOMAIN')}/" + imgUrl;
                    var img = new Image()
                    img.onload = function() {
                        var width = 0
                        if(this.width > $(document).width()) {
                            width = $(document).width()
                        }else{
                            width = parseInt(this.width) + 30
                        }
                        $('#fix_dialog_width').width(width)
                        $('#myModal').modal('show');
                        $("#Preview").attr("src", imgUrlFull);
                    }
                    img.src = imgUrlFull
                }
            });

            // 修改请求
            function positionEdit(data, confirms) {
                data["confirm"] = confirms || 0;
                $.post("/advposition/add_position", data, function (result) {
                    if (result.status == 1) {
                        if (confirms == 1) {
                            window.location.replace("/advposition/position_detail?id=" + result["data"]["id"]);
                        } else if (window.confirm("是否确认" + (data["id"] == "" ? "添加" : "修改") + "此广告位") == true) {
                            positionEdit(data, 1);
                        }
                    } else {
                        alert(result.info);
                    }
                });
            }

            $('.confirm-btn').on('click', function () {
                var data = {
                    id: "{$info.id}",
                    name: $('.ad-name').val(),
                    position_id: $('.position-name').val(),
                    type: $("input:radio[name='adStyle']:checked").val(),
                    demand: $('.ad-request').val(),
                    enabled: $("input:radio[name='using']:checked").val(),
                    preview:  $('input[name=img_url]').val()
                };

                if (data['name'].trim() == '') {
                    alert('请填写广告位名称')
                    $('.ad-name').val('')
                    return
                }

                if (data["name"].length > 20) {
                    alert('广告位名称长度最多20个字符')
                    return false;
                }

                if (data["position_id"] == "") {
                    alert('请先选择广告位置')
                    return false;
                }
                if (data.preview == '') {
                    alert('请上传预览图片')
                    return
                }

                positionEdit(data);
            })

            $(".unChange-btn").on("click", function () {
                let id = $(this).data("id")
                layer.confirm("是否放弃修改此广告位", {
                    btn: ["确定", "取消"],//按钮
                }, function () {
                    window.location.href = "/advposition/position_detail?id=" + id
                }, function () {

                });
            });

            $(".giveup-add").on("click", function(){
                layer.confirm("是否要放弃添加此广告位", {
                    btn: ["确定", "取消"],//按钮
                    title: ""
                }, function () {
                    window.location.href = "/advposition/position"
                }, function () {

                });
            });
        })
    </script>

</block>



