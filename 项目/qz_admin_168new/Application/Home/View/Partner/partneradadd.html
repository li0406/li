<extend name="Main:baseTemplate" />
<block name="title">
    <title>添加异业合作广告 - 控制台</title>
</block>
<block name="style">
    <link rel="stylesheet" href="/assets/common/css/global.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="/assets/home/partner/css/ad.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" type="text/css" href="/assets/common/js/plugins/datetimepicker/datepicker.css?v={:C('STATIC_VERSION')}" />
    <link rel="stylesheet" href="/assets/common/plugins/layer/theme/default/layer.css?v={:C('STATIC_VERSION')}">
</block>

<block name="content">
    <section class="content-header">
        <div class="row">
            <div class="col-xs-12">
                <div class="box" style="margin-bottom: 0">
                    <div class="box-body act-box" style="min-width:500px;padding: 0">
                        <nav class="nav">
                            <span>添加异业合作广告</span><span> > <if condition="$edit eq 1">编辑<else />添加</if></span>
                        </nav>
                    </div>
                </div>
            </div>
        </div>

    </section>
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-body act-box" style="min-width:500px" id="box-head">
                        <form  id="add-ad">
                            <div class="control-group col-sm-12">
                                <label for=""><span class="red">*</span>广告名称：</label>
                                <input type="text" class="form-control ke-inline-block" name="ad_name" value="{$info.title}">
                                <input type="hidden" id="partner_id" value="{$info.id}">
                            </div>
                            <div class="control-group col-sm-12">
                                <label for="">合作方：</label>
                                <input type="text" class="form-control" name="cooperater" value="{$info.partner}">
                            </div>
                            <div class="control-group col-sm-12">
                                <label for=""><span class="red">*</span>有效时间：</label>
                                <input type="text" class="form-control datepicker" readonly name="start_time" placeholder="开始时间" value="{$info.start|default=''|date='Y-m-d',###}"> -
                                <input type="text" class="form-control datepicker" readonly name="end_time" placeholder="结束时间" value="{$info.end|default=''|date='Y-m-d',###}">
                            </div>
                            <div class="control-group col-sm-12">
                                <label for="" class="top"><span class="red">*</span>上传广告：</label>
                                <div class="ad-img-link">
                                <table style="border:none">
                                    <tr>
                                        <td></td>
                                        <td>广告图片</td>
                                        <td>广告链接</td>
                                        <td>投放系数</td>
                                    </tr>
                                    <tr>
                                        <td>PC端</td>
                                        <td><input type="file" id="pc-upload"><input type="hidden" name="pc-ad-img" value="{$info.pc_img}"></td>
                                        <td><input type="text" name="pc-ad-link" class="form-control" value="{$info.pc_url}"></td>
                                        <td><input type="text" name="pc-ad-ratio" class="form-control" value="{$info.pc_coefficient}"></td>
                                    </tr>
                                    <tr>
                                        <td>m端</td>
                                        <td><input type="file" id="m-upload"><input type="hidden" name="m-ad-img" value="{$info.m_img}"></td>
                                        <td><input type="text" name="m-ad-link" class="form-control" value="{$info.m_url}"></td>
                                        <td><input type="text" name="m-ad-ratio" class="form-control" value="{$info.m_coefficient}"></td>
                                    </tr>
                                </table>
                                </div>
                            </div>
                            <div class="control-group col-sm-12">
                                <label for="" class="top"><span class="red">*</span>投放页面：</label>
                                <div class="drop-page">
                                    <p>装修-PC端</p>
                                    <select multiple="multiple" size="10" class="form-control inline-block" data-name="zxpc-origin">
                                        <volist name="location[1]" id="vo">
                                            <option value ="{$vo.id}">{$vo.name}</option>
                                        </volist>
                                    </select>
                                    <div class="inline-block switch-arrow">
                                        <p data-target="zxpc-target" class="switch-arrow-btn">--></p>
                                        <p data-target="zxpc-origin" class="switch-arrow-btn"><--</p>
                                    </div>
                                    <select multiple="multiple" size="10" class="form-control inline-block" data-name="zxpc-target">
                                        <volist name="locationtemp[1]" id="vo0">
                                            <option value ="{$vo0.id}">{$vo0.name}</option>
                                        </volist>
                                    </select>
                                </div>
                                <div class="drop-page">
                                    <p>装修-M端</p>
                                    <select multiple="multiple" size="10" class="form-control inline-block" data-name="zxm-origin">
                                        <volist name="location[2]" id="vo1">
                                            <option value ="{$vo1.id}">{$vo1.name}</option>
                                        </volist>
                                    </select>
                                    <div class="inline-block switch-arrow">
                                        <p data-target="zxm-target" class="switch-arrow-btn">--></p>
                                        <p data-target="zxm-origin" class="switch-arrow-btn"><--</p>
                                    </div>
                                    <select multiple="multiple" size="10" class="form-control inline-block" data-name="zxm-target">
                                        <volist name="locationtemp[2]" id="vo11">
                                            <option value ="{$vo11.id}">{$vo11.name}</option>
                                        </volist>
                                    </select>
                                </div>
                                <div style="padding-left: 154px; padding-top: 20px;">
                                    <div class="drop-page">
                                        <p>家具-PC端</p>
                                        <select multiple="multiple" size="10" class="form-control inline-block" data-name="jjpc-origin">
                                            <volist name="location[3]" id="vo2">
                                                <option value ="{$vo2.id}">{$vo2.name}</option>
                                            </volist>
                                        </select>
                                        <div class="inline-block switch-arrow">
                                            <p data-target="jjpc-target" class="switch-arrow-btn">--></p>
                                            <p data-target="jjpc-origin" class="switch-arrow-btn"><--</p>
                                        </div>
                                        <select multiple="multiple" size="10" class="form-control inline-block" data-name="jjpc-target">
                                            <volist name="locationtemp[3]" id="vo22">
                                                <option value ="{$vo22.id}">{$vo22.name}</option>
                                            </volist>
                                        </select>
                                    </div>
                                    <div class="drop-page">
                                        <p>家具-M端</p>
                                        <select multiple="multiple" size="10" class="form-control inline-block" data-name="jjm-origin">
                                            <volist name="location[4]" id="vo3">
                                                    <option value ="{$vo3.id}">{$vo3.name}</option>
                                            </volist>
                                        </select>
                                        <div class="inline-block switch-arrow">
                                            <p data-target="jjm-target" class="switch-arrow-btn">--></p>
                                            <p data-target="jjm-origin" class="switch-arrow-btn"><--</p>
                                        </div>
                                        <select multiple="multiple" size="10" class="form-control inline-block" data-name="jjm-target">
                                            <volist name="locationtemp[4]" id="vo33">
                                                <option value ="{$vo33.id}">{$vo33.name}</option>
                                            </volist>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="control-group col-sm-12">
                                <label for=""><span class="red">*</span>是否启用：</label>
                                <select name="enabled" id="" class="form-control">
                                    <option value="">请选择</option>
                                    <option value="1" <if condition="$info.is_use eq 1">selected</if>>是</option>
                                    <option value="0"<if condition="$info.is_use eq 0">selected</if>>否</option>
                                </select>
                            </div>
                            <div class="control-group col-sm-12">
                                <button type="button" id="submit" class="btn btn-success" style="margin-left: 150px;">保存</button>
                                <button type="button" class="btn" onclick="location.href='/partner/partnerad'">取消</button>
                            </div>
                        </form>

                    </div>
                </div>
            </div>
        </div>

    </section>
</block>
<block name="script">
    <script type="text/javascript" src="/assets/common/js/plugins/datetimepicker/bootstrap-datepicker.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript" src="/assets/common/plugins/layer/layer.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript">
        var Global_Submit_url = ""
        $(function () {
            /* 日历插件 */
            $('.datepicker').datepicker({
                format:"yyyy-mm-dd",
                weekStart: 1,
                todayHighlight: 1,
                todayBtn: true,
                minView: 0,
                autoclose: true,
                language: 'zh-CN'
            }).on("change", function () {
                if (toTimeStamp($('input[name="start_time"]').val()) > toTimeStamp($('input[name="end_time"]').val())) {
                    layer.msg("结束时间不得早于开始时间");
                    $('input[name="end_time"]').val("");
                }
            });
            function toTimeStamp(time){
                if(time!=undefined){
                    var date = time;
                    date = date.substring(0,19);
                    date = date.replace(/-/g,'/');
                    var timestamp = new Date(date).getTime();
                    return timestamp;
                }
            };
        })

        $(function () {
            /* 投放页面select切换 */
            var $switchArrowBtn = $(".switch-arrow-btn");
            $switchArrowBtn.on("click", function () {
                var targetName = $(this).attr('data-target'),
                    $parent = $(this).closest(".drop-page"),
                    $pushTarget = $parent.find('select[data-name="' + targetName + '"]'), // 入栈对象
                    $popTarget = null, // 出栈对象
                    tempName = targetName.split('-');
                if(tempName[1] == 'target'){
                    $popTarget = $parent.find('select[data-name="' + tempName[0] + '-origin"]')
                }else{
                    $popTarget = $parent.find('select[data-name="' + tempName[0] + '-target"]')
                }
                if(!$popTarget.val()) {
                    layer.msg('请先选择一个投放页面')
                    return
                }
                $popTarget.find("option:selected").each(function(index, item) {
                    $pushTarget.append(item)
                })
                $popTarget.find("option:selected").remove()
                var sortOption = $pushTarget.find('option').sort(function(a,b){  //进行排序
                    var aText = $(a).val();
                    var bText = $(b).val();
                    if(aText > bText) return 1;
                    if(aText < bText) return -1;
                    return 0;
                });
                $pushTarget.empty(); //清空
                $pushTarget.append(sortOption); //赋值
            })
        })

        $(function () {
            /* 表单提交 */
            $('#submit').on('click', function(){
                var adName = $('input[name="ad_name"]').val(),
                    id = $('#partner_id').val(),
                    cooperater =  $('input[name="cooperater"]').val(),
                    start_time =  $('input[name="start_time"]').val(),
                    end_time = $('input[name="end_time"]').val(),
                    pcAdImg = $('input[name="pc-ad-img"]').val(),
                    pcAdLink = $('input[name="pc-ad-link"]').val(),
                    pcAdRatio = $('input[name="pc-ad-ratio"]').val(),
                    mAdImg = $('input[name="m-ad-img"]').val(),
                    mAdLink = $('input[name="m-ad-link"]').val(),
                    mAdRatio = $('input[name="m-ad-ratio"]').val(),
                    $dropZxpc = $('select[data-name="zxpc-target"]').find('option'),
                    dropZxpc = [],
                    $dropZxm = $('select[data-name="zxm-target"]').find('option'),
                    dropZxm = [],
                    $dropJjxm = $('select[data-name="jjpc-target"]').find('option'),
                    dropJjxm = [],
                    $dropJjm = $('select[data-name="jjm-target"]').find('option'),
                    dropJjm = [],
                    enabled = $('select[name="enabled"]').val();
                if(!adName){
                    layer.msg("广告名称不能为空！");
                    $('input[name="ad_name"]').focus();
                    return false;
                }
                if(start_time == ''){
                    layer.msg("投放开始时间不能为空！");
                    $('input[name="start_time"]').focus();
                    return false;
                }
                if(end_time == ''){
                    layer.msg("投放结束时间不能为空！");
                    $('input[name="end_time"]').focus();
                    return false;
                }
                if(!pcAdImg && !pcAdLink && !pcAdRatio && !mAdImg && !mAdLink && !mAdRatio){
                    layer.msg("请至少填写一个上传广告信息");
                    $('input[name="pc-ad-link"]').focus();
                    return false;
                }
                if(pcAdImg || pcAdLink || pcAdRatio){
                    if(!pcAdImg) {
                        layer.msg("PC端广告图片不能为空");
                        $('#pc-upload').focus();
                        return false;
                    }
                    if(!pcAdLink) {
                        layer.msg("PC端广告链接不能为空");
                        $('input[name="pc-ad-link"]').focus();
                        return false;
                    }
                    if(!pcAdRatio) {
                        layer.msg("PC端广告投放系数不能为空");
                        $('input[name="pc-ad-ratio"]').focus();
                        return false;
                    }
                }
                if(mAdImg || mAdRatio || mAdLink){
                    if(!mAdImg) {
                        layer.msg("M端广告图片不能为空");
                        $('#m-upload').focus();
                        return false;
                    }
                    if(!mAdLink) {
                        layer.msg("M端广告链接不能为空");
                        $('input[name="m-ad-link"]').focus();
                        return false;
                    }
                    if(!mAdRatio) {
                        layer.msg("M端广告投放系数不能为空");
                        $('input[name="m-ad-ratio"]').focus();
                        return false;
                    }
                }
                if($dropZxpc.length <= 0 && $dropZxm.length <= 0 && $dropJjxm.length <= 0 && $dropJjm.length <= 0){
                    layer.msg("请至少选择一个投放页面");
                    $('select[data-name="zxpc-origin"]').focus();
                    return false;
                }
                if(!enabled){
                    layer.msg("请选择是否启用");
                    $('select[name="enabled"]').focus();
                    return false;
                }
                $.ajax({
                    url: Global_Submit_url,
                    type: 'POST',
                    dataType: 'JSON',
                    data:{
                        id:id,
                        adName: adName,
                        cooperater: cooperater,
                        start_time: start_time,
                        end_time: end_time,
                        pcAdImg: pcAdImg,
                        pcAdLink: pcAdLink,
                        pcAdRatio: pcAdRatio,
                        mAdImg: mAdImg,
                        mAdLink: mAdLink,
                        mAdRatio: mAdRatio,
                        dropZxpc: getAllOption($dropZxpc),
                        dropZxm: getAllOption($dropZxm),
                        dropJjxm: getAllOption($dropJjxm),
                        dropJjm: getAllOption($dropJjm),
                        enabled: enabled
                    }
                })
                    .done(function(data) {
                        if (data.error_code == 0) {
                            layer.msg("添加成功");
                            window.location.href = '/partner/partnerad';
                        } else {
                            layer.msg(data.info);
                            return false;
                        }
                    })
                    .fail(function(xhr) {
                        layer.msg('发生未知错误，请稍后重试~');
                        return false;
                    })
            });

            function getAllOption(ele) {
                var temp = [];
                $(ele).each(function (index, item) {
                    temp.push($(item).val())
                })
                return temp
            }
        })

        $(function () {
            var pcInitialPreview = [], mInitialPreview = [];
        <notempty name='info.pc_img'>
                pcInitialPreview = [
                    "<img src='{$info.pc_img}' class='file-preview-image' >"
                ];
                </notempty>
                <notempty name='info.m_img'>
                mInitialPreview = [
                "<img src='{$info.m_img}' class='file-preview-image' >"
            ];
                </notempty>
            /* 文件上传 */
            $("#pc-upload").fileinput({
                    language: 'zh', //设置语言,
                    uploadUrl:"/upload/uploadimg/",
                    showCaption: false,
                    browseClass:"btn btn-primary",
                    allowedFileExtensions : ['jpg','png','gif'],
                    maxFileCount: 1,
                    uploadClass:"btn btn-info",
                    removeClass:"btn btn-danger",
                    uploadAsync: true,
                    dropZoneEnabled:false,
                    uploadExtraData: {
                        prefix:'ad',
                        chars:'true'
                    },
                    minImageWidth: 415, //图片的最小宽度
                    minImageHeight: 206,//图片的最小高度
                    maxImageWidth: 415,//图片的最大宽度
                    maxImageHeight: 206,//图片的最大高度
                    maxFileSize:1000000000,
                    previewSettings:{
                        image: {width: "323px", height: "164px"}
                    },
                    initialPreview: pcInitialPreview,

        }).on('fileuploaded', function(event, data, id, index) {
                console.log(data)
                if(1 == data.response.status){
                    $('input[name="pc-ad-img"]').val(data.response.data.url);
                }else{
                    alert(data.response.info);
                    return false;
                }
            }).on("fileuploaderror",function(event, data){
                alert('文件上传失败,请检查文件格式，规格是否符合要求！')
                return false;
            }).on("fileclear", function () {
                $('input[name="pc-ad-img"]').val("");
            }).on("filebatchselected", function (event, files) {
                if ($('input[name="pc-ad-img"]').val()) {
                    layer.msg('只能上传一张图片')
                    $(".file-preview-frame").each(function (index, item) {
                        if (!$(item).hasClass("file-preview-success")) {
                            $(item).remove()
                        }
                    })
                }
            });

            $("#m-upload").fileinput({
                    language: 'zh', //设置语言,
                    uploadUrl:"/upload/uploadimg/",
                    showCaption: false,
                    browseClass:"btn btn-primary",
                    allowedFileExtensions : ['jpg','png','gif'],
                    maxFileCount: 1,
                    uploadClass:"btn btn-info",
                    removeClass:"btn btn-danger",
                    uploadAsync: true,
                    dropZoneEnabled:false,
                    uploadExtraData: {
                        prefix:'ad',
                        chars:'true'
                    },
                    minImageWidth: 283, //图片的最小宽度
                    minImageHeight: 132,//图片的最小高度
                    maxImageWidth: 283,//图片的最大宽度
                    maxImageHeight: 132,//图片的最大高度
                    maxFileSize:1000000000,
                    previewSettings:{
                        image: {width: "323px", height: "164px"}
                    },
                    initialPreview: mInitialPreview
        }).on('fileuploaded', function(event, data, id, index) {
                if(1 == data.response.status){
                    $('input[name="m-ad-img"]').val(data.response.data.url);
                }else{
                    alert(data.response.info);
                    return false;
                }
            }).on("fileuploaderror",function(event, data){
                alert('文件上传失败,请检查文件格式，规格是否符合要求！')
                return false;
            }).on("fileclear", function () {
                $('input[name="m-ad-img"]').val("");
            }).on("filebatchselected", function (event, files) {
                if ($('input[name="m-ad-img"]').val()) {
                    layer.msg('只能上传一张图片')
                    $(".file-preview-frame").each(function (index, item) {
                        if (!$(item).hasClass("file-preview-success")) {
                            $(item).remove()
                        }
                    })
                }
            });
        })

    </script>
</block>
