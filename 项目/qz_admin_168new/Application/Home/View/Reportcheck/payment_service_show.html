<!--查看-erp(通用)-->
<extend name="Main:baseTemplate"/>
<block name="style">
    <link rel="stylesheet" type="text/css" href="/assets/common/css/select2_metro.css?v={:C('STATIC_VERSION')}"/>
    <link rel="stylesheet" type="text/css" href="/assets/common/css/Alert.css?v={:C('STATIC_VERSION')}"/>
    <link href="/assets/common/js/plugins/datetimepicker/datepicker.css?v={:C('STATIC_VERSION')}"rel="stylesheet"/>
    <link rel="stylesheet" href="/assets/home/reportcheck/css/check.css?v={:C('STATIC_VERSION')}">

    <style type="text/css">
        section.content-header h1 span{ position: relative; top: 3px; left: 10px;}
    </style>
</block>

<block name="content">
    <section class="content-header">
        <h1>
            <a type="button" class="btn btn-primary" href="{$back_url}">返回</a>
            <span>查看详情</span> 
        </h1>
        <ol class="breadcrumb">
            <li><a href="/"><i class="fa fa-dashboard"></i> 控制面板</a></li>
            <li><a href="/reportcheck/payment_service_check/">返点小报备客服</a></li>
        </ol>
    </section>

    <section class="content">
        <div class="row content-box">
            <div class="col-xs-12">
                <div class="box box-default minHeight">
                    <div class="box-body">
                        <div class="row">
                            <form class="form-horizontal">
                                <div class="col-xs-6 item-box">
                                    <div class="col-xs-12 item-style">
                                        <div class="col-xs-3 justify">
                                            {$index++}.公司名称：
                                        </div>
                                        <span class="col-xs-9 item-right">
                                            {$info.company_name}
                                        </span>
                                    </div>
                                    <div class="col-xs-12 item-style">
                                        <div class="col-xs-3 justify">
                                            {$index++}.会员ID：
                                        </div>
                                        <span  class="col-xs-3 item-right">{$info.company_id}</span>
                                    </div>
                                    <div class="col-xs-12 item-style">
                                        <div class="col-xs-3 justify">
                                            {$index++}.合作类型：
                                        </div>
                                        <span  class="col-xs-3 item-right">{$info.cooperation_type_name}</span>
                                    </div>
                                    <div class="col-xs-12 item-style">
                                        <div class="col-xs-3 justify">
                                            {$index++}.收款城市：
                                        </div>
                                        <span  class="col-xs-3 item-right">{$info.city_name}</span>
                                    </div>

                                    <if condition="$info['cooperation_type'] eq $uback_type">
                                        <div class="col-xs-12 item-style">
                                            <div class="col-xs-3 justify">
                                                {$index++}.返点订单：
                                            </div>
                                            <span  class="col-xs-9 item-right">{$info.order_id}</span>
                                        </div>
                                        
                                        <div class="col-xs-12 item-style">
                                            <div class="col-xs-3 justify">
                                                {$index++}.签单金额：
                                            </div>
                                            <span  class="col-xs-3 item-right">{$info.order_qiandan_jine}万</span>
                                            
                                            <eq name="info.uback_money_compare" value="1">
                                                <div class="col-xs-6">应返金额：<font color="#009900">{$info.order_back_money}</font></div>
                                            <else />
                                                <div class="col-xs-6">应返金额：<font color="#ff0000">{$info.order_back_money}</font></div>
                                            </eq>
                                        </div>

                                        <div class="col-xs-12 item-style">
                                            <div class="col-xs-3 justify">
                                                {$index++}.装企签单返点：
                                            </div>
                                            <span  class="col-xs-3 item-right">{$info.back_ratio}</span>

                                            <div class="col-xs-3">实返金额：{$info.total_money}</div>
                                            <div class="col-xs-3">本次到账金额：{$info.payment_total_money}</div>
                                        </div>

                                        <div class="col-xs-12 item-style">
                                            <div class="col-xs-3 justify">
                                                {$index++}.保证金抵扣：
                                            </div>
                                            <span  class="col-xs-3 item-right" style="color: #0099ff;">{$info.deposit_money}</span>

                                            <div class="col-xs-6">
                                                <span>会员保证金余额：</span>
                                                <if condition="$info['deposit_money'] gt $company_account['deposit_money']">
                                                    <span class="red">{$company_account.deposit_money} </span>
                                                <else />
                                                    <span>{$company_account.deposit_money} </span>
                                                </if>
                                            </div>
                                        </div>

                                        <div class="col-xs-12 item-style">
                                            <div class="col-xs-3 justify">
                                                {$index++}.轮单费抵扣：
                                            </div>
                                            <span  class="col-xs-3 item-right" style="color: #0099ff;">{$info.round_order_money}</span>

                                            <div class="col-xs-6">
                                                <span>会员轮单费余额：</span>
                                                <if condition="$info['round_order_money'] gt $company_account['account_amount']">
                                                    <span class="red">{$company_account.account_amount} </span>
                                                <else />
                                                    <span>{$company_account.account_amount} </span>
                                                </if>
                                            </div>
                                        </div>
                                    </if>

                                    <if condition="$info['cooperation_type'] eq $platform_turn_type">
                                        <div class="col-xs-12 item-style">
                                            <div class="col-xs-3 justify">
                                                {$index++}.收款类型：
                                            </div>
                                            <span  class="col-xs-3 item-right">{$info.payment_type_name}</span>
                                        </div>

                                        <div class="col-xs-12 item-style">
                                            <div class="col-xs-3 justify">
                                                {$index++}.保证金抵扣金额：
                                            </div>

                                            <if condition="$info['deposit_to_platform_money'] elt $company_account['deposit_money']">
                                                <span class="col-xs-3 item-right" style="color: green;">{$info.deposit_to_platform_money}</span>
                                            <else />
                                                <span class="col-xs-3 item-right" style="color: red;">{$info.deposit_to_platform_money}</span>
                                            </if>

                                            <div class="col-xs-6">
                                                <span>保证金余额：</span>
                                                <span>{$company_account.deposit_money}</span>
                                            </div>
                                        </div>

                                        <div class="col-xs-12 item-style">
                                            <div class="col-xs-3 justify">
                                                {$index++}.平台使用费有效期：
                                            </div>
                                            <span  class="col-xs-9 item-right">
                                                {$info.platform_money_start_date} - {$info.platform_money_end_date}
                                            </span>
                                        </div>

                                        <div class="col-xs-12 item-style">
                                            <div class="col-xs-3 justify">
                                                {$index++}.汇款时间：
                                            </div>
                                            <span  class="col-xs-3 item-right">{$info.payment_date}</span>
                                        </div>
                                    </if>
                                    
                                    <div class="col-xs-12 item-style">
                                        <div class="col-xs-3 justify">
                                            {$index++}.销售备注：
                                        </div>
                                        <span  class="col-xs-9 item-right">
                                            {$info.remark}
                                        </span>
                                    </div>
                                    
                                    <if condition="$info['cooperation_type'] eq $platform_turn_type">
                                        <div class="col-xs-12 item-style">
                                            <div class="col-xs-3 justify">
                                                {$index++}.汇款凭证：
                                            </div>
                                            <div class="col-xs-9 item-right pr0 upload-img" id="upload-img">
                                                <volist name="info['auth_imgs']" id="item">
                                                    <img src="{$item.img_full}" alt="">
                                                </volist>
                                            </div>
                                        </div>
                                    </if>

                                    <div class="col-xs-12 item-style">
                                        <div class="col-xs-3 justify">
                                            {$index++}.报备人：
                                        </div>
                                        <span  class="col-xs-3 item-right">{$info.creator_name}</span>
                                        
                                        <if condition="count($info['person_list'])">
                                            <div class="col-xs-6">
                                                其他业绩人：
                                                <volist name="info.person_list" id="item">
                                                    {$item.saler_name}（{$item.share_ratio_text}）&nbsp;&nbsp;&nbsp;&nbsp;
                                                </volist>
                                            </div>
                                        </if>
                                    </div>

                                    <div class="col-xs-12 item-style">
                                        <div class="col-xs-3 justify">
                                            {$index++}.审批状态：
                                        </div>
                                        <span  class="col-xs-9 item-right">
                                            {$info.exam_status_name} 
                                            <if condition="in_array($info['exam_status'], [4, 6]) and $info['exam_reason']">
                                                <font color="red">（{$info.exam_reason}）</font>
                                            </if>
                                        </span>
                                    </div>

                                    <div class="col-xs-12 item-style no-border">
                                        <div class="col-xs-3 justify">
                                            {$index++}.所属部门：
                                        </div>
                                        <span  class="col-xs-9 item-right">
                                            {$info.top_team_name}
                                        </span>
                                    </div>

                                    <div class="col-xs-12 item-style no-border">
                                        <table class="table table-hover table-bordered">
                                            <thead>
                                            <tr>
                                                <th>操作时间</th>
                                                <th>操作状态</th>
                                                <th>审核备注</th>
                                                <th>操作人</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                <volist name="info['check_log']" id="vovo">
                                                    <tr>
                                                        <td>{$vovo.created_at|date="Y-m-d H:i:s",###}</td>
                                                        <td>{$vovo.action_type}</td>
                                                        <td>{$vovo.remark}</td>
                                                        <td>{$vovo.op_name}</td>
                                                    </tr>
                                                </volist>
                                                <if condition="count($info['check_log']) eq 0">
                                                    <tr>
                                                        <td colspan="4">暂无审核记录</td>
                                                    </tr>
                                                </if>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="col-xs-12 btns">
                                        <div class="col-xs-3">
                                            <a class="btn btn-default" href="{$back_url}">返回</a>
                                        </div>
                                        <if condition="$info['exam_status'] eq 5">
                                            <div class="col-xs-3">
                                                <button type="button" class="btn btn-warning button-check">审核</button>
                                            </div>
                                        </if>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mask" id="exam_layout">
            <div class="tip-box">
                <div class="tip-wrapper">
                    <div class="tip-header">
                        <h2>审核</h2>
                    </div>
                    <div class="tip-body">
                        <ul>
                            <li class="check-box" id="exam_status">
                                <span>审核：</span>
                                <label for="pass">
                                    <input type="radio" name="check-result" id="pass" value="1">通过
                                </label>
                                <label for="no-pass">
                                    <input type="radio" name="check-result" id="no-pass" value="2">不通过
                                </label>
                            </li>
                            <li class="remark-item" style="display: none;" id="exam_remark">
                                <span>备注：</span>
                                <textarea></textarea>
                            </li>
                            <li style="margin-top: 15px;">
                                <button class="btn btn-primary btn-check btn-confirm">确认</button>
                                <button class="btn btn-default btn-check btn-cancel">取消</button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 图片预览 -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog " id="fix_dialog_width" style="overflow-y:auto;">
            <div class="modal-content">
                <div class="modal-body"><img src="" id="my-Preview" style="display: block; width: 100%;height: 100%;"></div>
            </div>
        </div>
    </div>
</block>
<block name="script">
    <script type="text/javascript" src="/assets/common/plugins/layer/layer.js?v={:C('STATIC_VERSION')}"></script>
    <script>
        $(function () {
            $(".button-check").click(function(){
                $("#exam_layout").fadeIn();
            });

            $(".btn-cancel").on("click", function () {
                $("#exam_layout").fadeOut()
            })

            $("#exam_status input[type=radio]").change(function () {
                if (this.value == "1") {
                    $("#exam_remark").hide();
                } else {
                    $("#exam_remark").show();
                }
            });

            //审核操作
            $('.btn-confirm').click(function () {
                var remark = $('#exam_remark').find("textarea").val();
                var exam_status = $("#exam_status input[type=radio]:checked").val();
                if (exam_status == undefined) {
                    alert("请先选择审核状态");
                    return false;
                }

                check_payment_report(remark, exam_status, 1);
            });

            // 图片放大
            $('.upload-img img').click(function(){
                layer.photos({
                    photos: '#upload-img'
                    ,anim: 5 //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
                })
            });

            // 审核方法
            function check_payment_report(remark, exam_status, isconfirm){
                $.ajax({
                    url: "/reportcheck/check_payment_report",
                    type: "POST",
                    dataType: "json",
                    data: {
                        id: "{$info.id}",
                        remark: remark,
                        exam_status: exam_status,
                        isconfirm: isconfirm,
                        actfrom: 2
                    }
                }).done(function (response) {
                    if (response.error_code == 1100001) {
                        if (confirm("余额不够确定要审核通过吗？") == true) {
                            check_payment_report(remark, exam_status, 2);
                        }
                    } else if (response.error_code == 0) {
                        window.location.reload();
                    }else {
                        alert(response.error_msg);
                    }
                });
            }
        });
    </script>
</block>