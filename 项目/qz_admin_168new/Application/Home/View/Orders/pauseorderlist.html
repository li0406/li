<extend name="Main:baseTemplate"/>
<block name="style">
    <link rel="stylesheet" type="text/css"
          href="/assets/common/js/plugins/artdialog/ui-dialog.css?v={:C('STATIC_VERSION')}"/>
    <link href="/assets/common/js/plugins/datetimepicker/datepicker.css?v={:C('STATIC_VERSION')}" rel="stylesheet"/>
    <link rel="stylesheet" href="/assets/common/js/plugins/select2/select2.min.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet"
          href="/assets/common/js/plugins/bootstrap-dialog/bootstrap-dialog.min.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="/assets/home/orders/css/modifyriz.css?v={:C('STATIC_VERSION')}">
    <link rel="stylesheet" href="/assets/home/orders/css/index.css?v={:C('STATIC_VERSION')}">
</block>
<block name="content">
    <section class="content-header">
        <h1>订单列表</h1>
        <ol class="breadcrumb">
            <li><a href="/"><i class="fa fa-dashboard"></i> 控制面板</a></li>
            <li><a href="/orders/">订单列表</a></li>
        </ol>
    </section>
    <section class="content">
        <div class="row">
            <div class="col-xs-12">
                <div class="box box-default">
                    <div class="box-body">
                        <div class="row">
                            <form class="form-horizontal" action="/orders/pauseorderlist" method="get">
                                <div class="col-xs-12">
                                    <div class="col-xs-2 reset-padding">
                                        <div>订单查询：</div>
                                        <input type="text" name="condition" class="form-control clear-target"
                                               placeholder="订单号、电话、小区名称" value="{$Think.get.condition}">
                                    </div>
                                    <div class="col-xs-2">
                                        <div>发单时间-开始：</div>
                                        <input type="text" name="time_start"
                                               class="form-control datetimepicker clear-target" placeholder="选择日期"
                                               value="{$Think.get.time_start}">
                                    </div>
                                    <div class="col-xs-2">
                                        <div>发单时间-结束：</div>
                                        <input type="text" name="time_end"
                                               class="form-control datetimepicker clear-target" placeholder="选择日期"
                                               value="{$Think.get.time_end}">
                                    </div>
                                    <div class="col-xs-2">
                                        <div>实际发单时间-开始：</div>
                                        <input type="text" name="time_real_start"
                                               class="form-control datetimepicker clear-target" placeholder="选择日期"
                                               value="{$Think.get.time_real_start}">
                                    </div>
                                    <div class="col-xs-2">
                                        <div>实际发单时间-结束：</div>
                                        <input type="text" name="time_real_end"
                                               class="form-control datetimepicker clear-target" placeholder="选择日期"
                                               value="{$Think.get.time_real_end}">
                                    </div>
                                    <div class="col-xs-1">
                                        <div>所属区域：</div>
                                        <select id="city" name="city" type="text" placeholder="选择城市"
                                                class="form-control">
                                            <option value="">请选择</option>
                                            <volist name="main.city" id="vo">
                                                <option value="{$vo.cid}">{$vo.char_name}</option>
                                            </volist>
                                        </select>
                                    </div>
                                    <div class="col-xs-1">
                                        <div>&nbsp;</div>
                                        <select id="area" name="area" type="text" placeholder="选择区县"
                                                class="form-control">
                                            <option value="">请选择</option>
                                            <volist name="main.area" id="vo">
                                                <option value="{$vo.qz_areaid}"
                                                <if condition="$_GET['area'] eq $vo['qz_areaid']">selected</if>
                                                >{$vo.qz_area}</option>
                                            </volist>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-xs-12 set-mt16">
                                    <div class="col-xs-2">
                                        <div>订单备注：</div>
                                        <select name="remarks" type="text" class="form-control">
                                            <option value="全部">全部</option>
                                            <volist name="main.remarks" id="vo">
                                                <option value="{$vo}">{$vo}</option>
                                            </volist>
                                        </select>
                                    </div>
                                    <div class="col-xs-2">
                                        <div>订单归属人：</div>
                                        <select id="op_uid" name="op_uid" type="text" class="form-control">
                                            <option value="0">请选择</option>
                                            <volist name="main.operaters" id="vo">
                                                <option value="{$vo.id}">{$vo.cname}</option>
                                            </volist>
                                        </select>
                                    </div>
                                    <div class="col-xs-2">
                                        <div>订单来源:</div>
                                        <select name="source" class="form-control">
                                            <option value="">全部</option>
                                            <volist name="orderType" id="vo">
                                                <option value="{$vo.id}">{$vo.type_name}</option>
                                            </volist>
                                        </select>
                                    </div>
                                    <div class="col-xs-2">
                                        <div>装修类型：</div>
                                        <select name="orderlxs" type="text" class="form-control">
                                            <option value="">全部</option>
                                            <option value="1">新房装修</option>
                                            <option value="2">整体翻新</option>
                                            <option value="3">局部改造</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-xs-12 set-mt16">
                                    <button type="submit" id="search" class="btn btn-success col-xs-1">搜索</button>
                                    <button type="button" id="reset" class="btn btn-download col-xs-1">重置</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">订单列表</h3>
                        <button type="button" class="log-info btn pull-right">最近操作记录</button>
                        <a class="btn pull-right abtnbj" href="/CompanyLiangFang?status=-1">未量房订单</a>
                        <!-- <button type="button" class="btn pull-right"><a href="/CompanyLiangFang?status=-1">未量房订单</a></button> -->
                    </div>
                    <ul class="ol-tab-wrap">
                        <li class="ol-tab" data-tab='11'>新单</li>
                        <li class="ol-tab" data-tab='12'>次新单</li>
                        <li class="ol-tab" title="前日17：30至昨日17：30间的次订单" data-tab='13'>
                            扫单 <i class="fa fa-question-circle"></i>
                        </li>
                        <li class="ol-tab" data-tab='14'>待定单</li>
                        <li class="ol-tab ol-tab-active" data-tab='26'>压单</li>
                        <li class="ol-tab" data-tab='23'>有效单</li>
                        <li class="ol-tab" data-tab='22'>无效单</li>
                        <li class="ol-tab" data-tab='24'>暂时无效</li>
                        <li class="ol-tab" data-tab='25'>撤回单</li>
                        <li class="ol-tab" data-tab='0'>订单总览</li>
                    </ul>

                    <div class="new-order-wrap">
                        <div class="ol-neworder-wrap">
                            <ul class="ol-neworder-info">
                                <a href="javascript:void(0)">
                                    <li>截止目前剩余压单数量</li>
                                    <li>{$main.info.info.all_count|default=0}</li>
                                </a>
                            </ul>
                            <ul class="ol-neworder-info">
                                <a href="javascript:void(0)">
                                    <li>剩余未处理压单数量</li>
                                    <li>{$main.info.info.now_count|default=0}</li>
                                </a>
                            </ul>
                        </div>
                    </div>

                    <div class="box-body table-responsive no-padding">
                        <table class="table table-hover table-bordered" id="tablelist">
                            <thead>
                            <tr>
                                <th class="width-150">发布日期</th>
                                <th>订单备注</th>
                                <th>城市区县</th>
                                <if condition="I('get.wzd_orrder') EQ '1'">
                                    <th class="wzd_orrder" data-order='1'>完整度&nbsp;<span><i
                                            class="glyphicon glyphicon-sort-by-attributes"></i></span></th>
                                    <elseif condition="I('get.wzd_orrder') EQ '2'"/>
                                    <th class="wzd_orrder" data-order='2'>完整度&nbsp;<span><i
                                            class="glyphicon glyphicon-sort-by-attributes-alt"></i></span></th>
                                    <else/>
                                    <th class="wzd_orrder" data-order='0'>完整度&nbsp;<span><i
                                            class="glyphicon glyphicon-sort"></i></span></th>
                                </if>
                                <th>面积㎡</th>
                                <th>手机号码</th>
                                <th>订单来源</th>
                                <th>订单状态</th>
                                <th>处理状态</th>
                                <th>轮拨时间</th>
                                <th>上次呼出时间</th>
                                <th>订单归属人</th>
                                <th class="width-210">操作</th>
                            </tr>
                            </thead>
                            <tbody>
                            <volist name="main.info.list" id="vo">
                                <tr data-id="{$vo.order_id}"
                                    class='<if condition="($vo.on == 4) && ($vo.order2com_allread == 0)">fuchsia</if>'>
                                    <td>
                                        {$vo.time|date='Y-m-d H:i',###}
                                    </td>
                                    <td title="{$vo.remarks}">
                                        <!--新单且不为空则可选择备注-->
                                        <notempty name="vo.remarks">{$vo.remarks}</notempty>
                                        <notempty name="vo.remark_time">
                                            <div class="red" title="最近修改订单备注时间">{$vo.remark_time}</div>
                                        </notempty>
                                    </td>
                                    <td>
                                        {$vo.city}{$vo.area}
                                        <eq name="vo.timef" value="">
                                            <if condition="$vo['timex_ori'] gt 180">
                                                <div class="green" title="订单发布距现在已经有:{$vo.timex}">{$vo.timex}</div>
                                                <else/>
                                                <div class="red" title="订单发布距现在已经有:{$vo.timex}">{$vo.timex}</div>
                                            </if>
                                            <else/>
                                            <div class="red" title="拨打及时度(订单发布时间 到 第一次拨打电话时间):{$vo.timef}">{$vo.timef}
                                            </div>
                                        </eq>
                                    </td>
                                    <td>{$vo.wzd|default=0}%</td>
                                    <td>{$vo.mianji}</td>
                                    <td>
                                        <if condition="!empty($vo['apply_tel'][$main['admin']['id']])">
                                            <eq name="vo['apply_tel'][$main['admin']['id']]" value="1">
                                                <span class="text-yellow ">{$vo.tel}</span>
                                            </eq>
                                            <eq name="vo['apply_tel'][$main['admin']['id']]" value="2">
                                                <span class="text-green">{$vo.tel}</span>
                                            </eq>
                                            <eq name="vo['apply_tel'][$main['admin']['id']]" value="3">
                                                <span class="text-red">{$vo.tel}</span>
                                            </eq>
                                            <else/>
                                            {$vo.tel}
                                        </if>&nbsp;
                                        <notempty name="vo.apply_tel_status">
                                            <!--显号审核，此处必须要用全等于-->
                                            <if condition="in_array('1', explode(',', $vo['apply_tel_status']))">
                                                <!--如果有正在申请状态则显示蓝色审核按钮-->
                                                <a class="apply_tel" href="javascript:void(0)">
                                                    <span title="请审核显号" class="fa fa-eye-slash text-primary"></span>
                                                </a>
                                                <else/>
                                                <a class="apply_tel" href="javascript:void(0)">
                                                    <span title="已处理显号审核" class="fa fa-eye text-gray"></span>
                                                </a>
                                            </if>
                                        </notempty>

                                        <!--号码其他状态-->
                                        <gt name="vo.phone_repeat_count" value="1">
                                            <a title="手机号码重复次数" class="phone-repeat-order red"
                                               href="javascript:void(0)">
                                                重{$vo['phone_repeat_count'] -1}
                                            </a>
                                        </gt>
                                        <eq name="vo.order_blacklist_status" value="1">
                                            <a href="javascript:void(0)" class="red" title="本订单号码在黑名单当中">黑</a>
                                        </eq>
                                        <notempty name="vo.visitime">
                                            <div class="red" title="下次联系时间">
                                                {$vo.visitime|strtotime|date='Y-m-d',###}
                                            </div>
                                        </notempty>
                                    </td>
                                    <td>
                                        <if condition="!empty($vo['source_in'])">
                                            <volist name="orderType" id="v">
                                                <if condition="$vo['source_in'] eq $v['id']">
                                                    {$v.type_name}
                                                </if>
                                            </volist>
                                            <else/>
                                            默认
                                        </if>
                                    </td>
                                    <!--不同状态不同颜色-->
                                    <td>
                                        压单
                                    </td>
                                    <td>
                                        <switch name="vo.status">
                                            <case value="2">未处理</case>
                                            <case value="1">已处理</case>
                                            <case value="3">预处理</case>
                                        </switch>
                                    </td>

                                    <td>{$vo.appointed_time}</td>
                                    <td>
                                        <notempty name="vo.call_lasttime">
                                            <div class="red" title="上次呼叫时间" alt="上次呼叫时间">{$vo.call_lasttime}</div>
                                        </notempty>
                                    </td>
                                    <td>{$vo.owner_name}</td>
                                    <td data-id="{$vo.order_id}">
                                        <a href="javascript:void(0)"
                                               title="编辑订单:{$vo.order_id}|上次修改:{$vo.lasttime|date='Y-m-d H:i',###}|实际发布时间:{$vo.time_real|date='Y-m-d H:i',###}|活动名称:{$vo.source_remark}"
                                               class="btn-order-edit">编辑</a>
                                        <eq name="main.auth.checkcall" value="1">
                                            <gt name="vo.call_repeat_count" value="0">
                                                <a href="javascript:void(0)" title="点击查看" class="tel-history">
                                                    呼叫记录({$vo.call_repeat_count|default=0})
                                                </a>
                                            </gt>
                                        </eq>
                                    </td>
                                </tr>
                            </volist>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-xs-12">
                        {$main.info.page}
                    </div>
                </div>
            </div>
        </div>
        <!--公用记录模态框-->
        <div class="modal fade common-model" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
                        </button>
                        <h4 class="modal-title">记录列表</h4>
                    </div>
                    <div class="modal-body common-model-content"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <!--撤销原因模态框-->
        <div class="modal fade back-model" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
                        </button>
                        <h4 class="modal-title">记录列表</h4>
                    </div>
                    <div class="modal-body back-model-content"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <!--显号审核模态框-->
        <div class="modal fade" id="apply" role="dialog" aria-labelledby="myModalLabe1l" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span
                                class="sr-only">Close</span></button>
                        <h4>审核显号</h4>
                    </div>
                    <div class="modal-body" data-id="" style="height: auto;overflow: hidden;">
                        <div class="form-group">
                            <label>申请人</label>
                            <div class="row">
                                <div class="col-xs-8">
                                    <input type="input" class="form-control" disabled="disabled" name="applyuser"
                                           value="张三">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>申请理由</label>
                            <div class="row">
                                <div class="col-xs-12">
                                    <textarea disabled="disabled" class="form-control" name="applyreason"
                                              value=""></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-xs-8 modal-error-wrap"></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary btn-ok">同意</button>
                    </div>
                </div>
            </div>
        </div>
        <!--编辑订单模态框-->
        <div class="modal fade my-dialog" id="operate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-gray">
                        <em class="close" aria-hidden="true" style="font-style: normal;">×
                        </em>
                        <span></span>
                    </div>
                    <div class="modal-body">
                    </div>
                </div>
            </div>
        </div>

        <!--重复订单查看模态框-->
        <div class="modal fade my-dialog" id="myModel" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-gray">
                        <em class="close" aria-hidden="true" style="font-style: normal;">×
                        </em>
                        <span></span>
                    </div>
                    <div class="modal-body">
                    </div>
                </div>
            </div>
        </div>
    </section>
</block>
<block name="script">
    <script src="/assets/common/js/plugins/artdialog/dialog.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/common/js/plugins/datetimepicker/bootstrap-datepicker.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/common/js/plugins/select2/select2.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/common/js/plugins/jscookie/js/jscookie-1.0.2.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/common/js/plugins/dataTables/metisMenu.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/common/js/plugins/dataTables/jquery.dataTables.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/common/js/plugins/dataTables/dataTables.bootstrap.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/common/js/plugins/bootstrap-dialog/bootstrap-dialog.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/common/js/plugins/zeroclipboard/ZeroClipboard.min.js?v={:C('STATIC_VERSION')}"></script>
    <script src="/assets/home/orders/js/calculator.js?v={:C('STATIC_VERSION')}"></script>
    <script type="text/javascript" src="//api.map.baidu.com/api?v=1.4"></script>
    <present name="main.scramble">
        <!--S-抢单相关JS文件-->
        <script>
            $(document).ready(function () {
                //定时器定时检查获取新订单时间
                var setTimeInterval = setInterval(function () {
                    var lastTime = typeof (localStorage.lastTime) == 'undefined' ? 0 : localStorage.lastTime;
                    var nowTime = new Date().getTime();
                    var obtainButton = $('#obtain');
                    var intervalTime = parseInt('{$main.scramble.new_order_interval}');
                    if (nowTime - lastTime > intervalTime * 1000) {
                        //此处的判断条件不能合并在一起写
                        if (typeof (obtainButton.attr('disabled')) != 'undefined') {
                            obtainButton.removeAttr('disabled').html('获取新的订单');
                        }
                        ;
                    } else {
                        obtainButton.attr('disabled', 'disabled').html((intervalTime - parseInt((nowTime - lastTime) / 1000)) + 's后再次获取');
                    }
                }, 1000);

                //刷新订单状态请求
                $('#refresh').click(function (event) {
                    $.ajax({
                        url: '/orders/refreshordercount/',
                        type: 'POST',
                        dataType: 'JSON'
                    })
                        .done(function (data) {
                            if (data.status == '1') {
                                var data = data.data;
                                $('#currentNewOrderCount').text(data.new);
                                $('#currentUnfinishedOrderCount').text(data.unfinished);
                                $('#canObtainOrderCount').text(data.obtain);
                                $('#retractedOrderCount').text(data.retracted);
                                $('#averageOrderCount').text(data.average);
                            } else {
                                var e = dialog({
                                    title: '消息',
                                    content: data.info,
                                    okValue: '确 定',
                                    quickClose: true,
                                    ok: function () {
                                    }
                                });
                                e.show();
                                return false;
                            }
                        })
                        .fail(function (xhr) {
                            var e = dialog({
                                title: '消息',
                                content: '发生未知错误，请联系技术部门~',
                                okValue: '确 定',
                                quickClose: true,
                                ok: function () {
                                }
                            });
                            e.show();
                            return false;
                        })
                });
                //点击获取新订单
                $('#obtain').click(function (event) {
                    $.ajax({
                        url: '/orders/scrambleorder/',
                        type: 'POST',
                        dataType: 'JSON'
                    })
                        .done(function (data) {
                            if (data.status == '1') {
                                //只有成功获取到订单才需要30s等待，未成功获取则无需等待
                                localStorage.lastTime = new Date().getTime();
                                //点击获取新订单无需再次查询，直接请求给出提示就可以
                                var e = dialog({
                                    title: '消息',
                                    content: '获取新订单成功！',
                                    okValue: '确 定',
                                    cancelValue: '取 消',
                                    quickClose: true,
                                    ok: function () {
                                        window.location.href = window.location.href;
                                    },
                                    cancel: function () {
                                        window.location.href = window.location.href;
                                    }
                                });
                                e.show();
                                return false;
                            } else {
                                var e = dialog({
                                    title: '消息',
                                    content: data.info,
                                    okValue: '确 定',
                                    quickClose: true,
                                    ok: function () {
                                    }
                                });
                                e.show();
                                return false;
                            }
                        })
                        .fail(function (xhr) {
                            var e = dialog({
                                title: '消息',
                                content: '发生未知错误，请联系技术部门~',
                                okValue: '确 定',
                                quickClose: true,
                                ok: function () {
                                }
                            });
                            e.show();
                            return false;
                        })
                });
            })
        </script>
        <!--E-抢单相关JS文件-->
    </present>
    <script>
        $(document).ready(function () {
            /*S-初始化插件*/
            $('#city').select2();
            $('#op_uid').select2();

            $('.datepicker').datepicker({
                autoclose: true,
                format: 'yyyy-mm-dd'
            });
            $('.datetimepicker').datetimepicker({
                weekStart: 1,
                todayHighlight: 1,
                todayBtn: true,
                minView: 0,
                autoclose: true
            });
            $('.wzd_orrder').click(function (event) {
                var order = $(this).attr('data-order');
                if ('1' == order) {
                    $(this).attr('data-order', '2');
                    $(this).find('span').html('<i class="glyphicon glyphicon-sort-by-attributes-alt"></i>');
                } else if ('2' == order) {
                    $(this).attr('data-order', '0');
                    $(this).find('span').html('<i class="glyphicon glyphicon-sort"></i>');
                } else {
                    $(this).attr('data-order', '1');
                    $(this).find('span').html('<i class="glyphicon glyphicon-sort-by-attributes"></i>');
                }
                $('.wzd_orrder').unbind('click');
                $('#search').trigger('click');
            });
            /*E-初始化插件*/

            /*S-申请显号*/
            $('.apply_tel').click(function (event) {
                var id = $(this).parent().parent().attr('data-id');
                if (id == '' || typeof (id) == 'undefined' || id == null) {
                    return false;
                }
                ;
                $.ajax({
                    url: '/orders/getapplytellist/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        id: id
                    }
                })
                    .done(function (data) {
                        if (data.status == '1') {
                            $('.common-model-content').empty();
                            $('.common-model-content').html(data.data);
                            $('.common-model').modal('show');
                        } else {
                            var e = dialog({
                                title: '消息',
                                content: data.info,
                                okValue: '确 定',
                                quickClose: true,
                                ok: function () {
                                }
                            });
                            e.show();
                            return false;
                        }
                    })
                    .fail(function (xhr) {
                        var e = dialog({
                            title: '消息',
                            content: '发生未知错误，请联系技术部门~',
                            okValue: '确 定',
                            quickClose: true,
                            ok: function () {
                            }
                        });
                        e.show();
                        return false;
                    })
            });
            $("body").on("click", ".btn-apply-tel", function (event) {
                $.ajax({
                    url: '/orders/displaynumbercheck/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        id: $(this).parent().attr('data-id'),
                        status: $(this).attr('data-status')
                    }
                })
                    .done(function (data) {
                        alert(data.info);
                        $('.common-model').modal('hide');
                    })
                    .fail(function (xhr) {
                        alert('操作失败,网络错误，请稍后重试或联系技术部门');
                    })
            })
            /*E-申请显号*/

            /*S-IP重复订单*/
            $('.ip-repeat-order').click(function (event) {
                var id = $(this).parent().parent().attr('data-id');
                var _this = $(this);
                $.ajax({
                    url: '/orders/getrepeatorderlistbyip/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        id: id
                    }
                })
                    .done(function (data) {
                        if (data.status == '1') {
                            $('.common-model-content').empty();
                            $('.common-model-content').html(data.data);
                            $('.common-model').modal('show');
                        } else {
                            var e = dialog({
                                title: '消息',
                                content: data.info,
                                okValue: '确 定',
                                quickClose: true,
                                ok: function () {
                                }
                            });
                            e.show();
                            return false;
                        }
                    })
                    .fail(function (xhr) {
                        var e = dialog({
                            title: '消息',
                            content: '发生未知错误，请联系技术部门~',
                            okValue: '确 定',
                            quickClose: true,
                            ok: function () {
                            }
                        });
                        e.show();
                        return false;
                    })
            });
            /*E-IP重复订单*/

            /*S-手机号重复订单*/
            $('.phone-repeat-order').click(function (event) {
                var id = $(this).parent().parent().attr('data-id');
                var _this = $(this);
                $.ajax({
                    url: '/orders/getrepeatorderlistbyphone/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        id: id
                    }
                })
                    .done(function (data) {
                        if (data.status == '1') {
                            $('.common-model-content').empty();
                            $('.common-model-content').html(data.data);
                            $('.common-model').modal('show');
                        } else {
                            var e = dialog({
                                title: '消息',
                                content: data.info,
                                okValue: '确 定',
                                quickClose: true,
                                ok: function () {
                                }
                            });
                            e.show();
                            return false;
                        }
                    })
                    .fail(function (xhr) {
                        var e = dialog({
                            title: '消息',
                            content: '发生未知错误，请联系技术部门~',
                            okValue: '确 定',
                            quickClose: true,
                            ok: function () {
                            }
                        });
                        e.show();
                        return false;
                    })
            });
            /*E-手机号重复订单*/

            /*S-最近操作记录*/
            $('.log-info').click(function (event) {
                $.ajax({
                    url: '/orders/getrecentoperatelog/',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {}
                })
                    .done(function (data) {
                        if (data.status == '1') {
                            $('.common-model-content').empty();
                            $('.common-model-content').html(data.data);
                            $('.common-model').modal('show');
                        } else {
                            var e = dialog({
                                title: '消息',
                                content: data.info,
                                okValue: '确 定',
                                quickClose: true,
                                ok: function () {
                                }
                            });
                            e.show();
                            return false;
                        }
                    })
                    .fail(function (xhr) {
                        var e = dialog({
                            title: '消息',
                            content: '发生未知错误，请联系技术部门~',
                            okValue: '确 定',
                            quickClose: true,
                            ok: function () {
                            }
                        });
                        e.show();
                        return false;
                    })
            });

            /*E-最近操作记录*/

            function getUrlParam(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
                var r = window.location.search.substr(1).match(reg);  //匹配目标参数
                if (r != null) return unescape(r[2]);
                return null; //返回参数值
            }

            if (getUrlParam("bs") == 'cx'){

                    $.ajax({
                        url: '/orders/operate/',
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            id: getUrlParam("condition"),
                            check_status: "{$_GET['status']|default=''}"
                        }
                    })
                        .done(function (data) {
                            if (data.status == 1) {
                                var header = "  修改订单  " + data.info.id + " (上次修改  " + data.info.lasttime + "  )   |   实际发布时间:" + data.info.time_real + " |   订单发布完整度：" + data.info.wzd + " %" + " |   家具订单：" + data.info.jiaju_order_id;

                                if (data.info.activity != null) {
                                    header += " | 活动名称: " + data.info.activity.name;
                                }

                                $("#operate .modal-header span").html(header);
                                $("#operate .modal-body").html(data.data);
                                $("#operate").modal({
                                    backdrop: false
                                }).on("shown.bs.modal", function () {
                                    ZeroClipboard.destroy();
                                    var client = new ZeroClipboard($("#copy"));
                                    client.on('copy', function (event) {
                                        var command_need = $("textarea[name=text]").val();//获取装修要求文本
                                        var pre_string = new Array("【1.设计施工要求】：", "【2.材料要求】：", "【3.不含家具家电总预算】：", "【4.对装修公司的要求】：", "【5.量房注意事项】：", "【6.工期】：", "【2.不含家具家电总预算】：", "【3.对装修公司的要求】：", "【4.量房注意事项】：");
                                        for (var i = 0; i < pre_string.length; i++) {
                                            command_need = command_need.replace(pre_string[i], "");//遍历替换前缀说明
                                        }
                                        //第一条的时候要加换行\r\n
                                        var copytxt = "【齐装网】" + $("[name=qx]").find("option:selected").text() + " "
                                            + $("[name=xiaoqu]").val() + " "
                                            + $("[name=dz]").val() + " "
                                            + "\r\n " + command_need + " 业主:" + $("[name=name]").val()
                                            + $("[name=sex]").find("option:selected").text()
                                            + " 手机上直接查看: " + $("input[name=dwz]").val();

                                        event.clipboardData.setData('text/plain', copytxt);

                                        alert("复制成功");
                                    });

                                    var company = new ZeroClipboard($("#copy-company"));
                                    company.on('copy', function (event) {
                                        var copytxt = "";
                                        $(".fen-company").each(function () {
                                            copytxt += $(this).text() + " ";
                                        });

                                        event.clipboardData.setData('text/plain', copytxt);
                                        alert("复制成功");
                                    });
                                });
                            } else {
                                var e = dialog({
                                    title: '消息',
                                    content: data.info,
                                    okValue: '确 定',
                                    quickClose: true,
                                    ok: function () {
                                    }
                                });
                                e.show();
                                return false;
                            }
                        });
            }

                /*S-编辑订单*/
                $("body").on("click", ".btn-order-edit", function (event) {
                    var id = $(this).parent().attr("data-id");
                    console.log(id)
                    $.ajax({
                        url: '/orders/operate/',
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            id: id,
                            check_status: "{$_GET['status']|default=''}"
                        }
                    })
                        .done(function (data) {
                            if (data.status == 1) {
                                var header = "  修改订单  " + data.info.id + " (上次修改  " + data.info.lasttime + "  )   |   实际发布时间:" + data.info.time_real + " |   订单发布完整度：" + data.info.wzd + " %" + " |   家具订单：" + data.info.jiaju_order_id;

                                if (data.info.activity != null) {
                                    header += " | 活动名称: " + data.info.activity.name;
                                }

                                $("#operate .modal-header span").html(header);
                                $("#operate .modal-body").html(data.data);
                                $("#operate").modal({
                                    backdrop: false
                                }).on("shown.bs.modal", function () {
                                    ZeroClipboard.destroy();
                                    var client = new ZeroClipboard($("#copy"));
                                    client.on('copy', function (event) {
                                        var command_need = $("textarea[name=text]").val();//获取装修要求文本
                                        var pre_string = new Array("【1.设计施工要求】：", "【2.材料要求】：", "【3.不含家具家电总预算】：", "【4.对装修公司的要求】：", "【5.量房注意事项】：", "【6.工期】：", "【2.不含家具家电总预算】：", "【3.对装修公司的要求】：", "【4.量房注意事项】：");
                                        for (var i = 0; i < pre_string.length; i++) {
                                            command_need = command_need.replace(pre_string[i], "");//遍历替换前缀说明
                                        }
                                        //第一条的时候要加换行\r\n
                                        var copytxt = "【齐装网】" + $("[name=qx]").find("option:selected").text() + " "
                                            + $("[name=xiaoqu]").val() + " "
                                            + $("[name=dz]").val() + " "
                                            + "\r\n " + command_need + " 业主:" + $("[name=name]").val()
                                            + $("[name=sex]").find("option:selected").text()
                                            + " 手机上直接查看: " + $("input[name=dwz]").val();

                                        event.clipboardData.setData('text/plain', copytxt);

                                        alert("复制成功");
                                    });

                                    var company = new ZeroClipboard($("#copy-company"));
                                    company.on('copy', function (event) {
                                        var copytxt = "";
                                        $(".fen-company").each(function () {
                                            copytxt += $(this).text() + " ";
                                        });

                                        event.clipboardData.setData('text/plain', copytxt);
                                        alert("复制成功");
                                    });
                                });
                            } else {
                                var e = dialog({
                                    title: '消息',
                                    content: data.info,
                                    okValue: '确 定',
                                    quickClose: true,
                                    ok: function () {
                                    }
                                });
                                e.show();
                                return false;
                            }
                        });
                });

            $("#operate .modal-header em").click(function (event) {
                if (confirm("确定关闭？")) {
                    $(".my-dialog").modal("hide");
                }
            });
            /*E-编辑订单*/

            /*S-重复订单编辑查看*/
            $("body").on("click", ".btn-repeatcheck", function (event) {
                var id = $(this).parent().attr("data-id");
                $.ajax({
                    url: '/orders/repeatcheck/',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        id: id
                    }
                })
                    .done(function (data) {
                        if (data.code == 200) {
                            $("#myModel .modal-header span").html("  修改订单  " + data.info.id + " (上次修改  " + data.info.lasttime + "  )   |   实际发布时间:" + data.info.time_real + " |   订单发布完整度：" + data.info.wzd + " %");
                            $("#myModel .modal-body").html(data.data);
                            $("#myModel").modal({
                                backdrop: true
                            }).on("shown.bs.modal", function () {
                                ZeroClipboard.destroy();
                                var client = new ZeroClipboard($("#copy"));
                                client.on('copy', function (event) {
                                    var command_need = $("textarea[name=text]").val();//获取装修要求文本
                                    var pre_string = new Array("【1.设计施工要求】：", "【2.材料要求】：", "【3.不含家具家电总预算】：", "【4.对装修公司的要求】：", "【5.量房注意事项】：", "【6.工期】：", "【2.不含家具家电总预算】：", "【3.对装修公司的要求】：", "【4.量房注意事项】：");
                                    for (var i = 0; i < pre_string.length; i++) {
                                        command_need = command_need.replace(pre_string[i], "");//遍历替换前缀说明
                                    }
                                    //第一条的时候要加换行\r\n
                                    var copytxt = "【齐装网】" + $("[name=qx]").find("option:selected").text() + " "
                                        + $("[name=xiaoqu]").val() + " "
                                        + $("[name=dz]").val() + " "
                                        + "\r\n " + command_need + " 业主:" + $("[name=name]").val()
                                        + $("[name=sex]").find("option:selected").text()
                                        + " 手机上直接查看: " + $("input[name=dwz]").val();

                                    event.clipboardData.setData('text/plain', copytxt);

                                    alert("复制成功");
                                });

                                var company = new ZeroClipboard($("#copy-company"));
                                company.on('copy', function (event) {
                                    var copytxt = "";
                                    $(".fen-company").each(function () {
                                        copytxt += $(this).text() + " ";
                                    });
                                    event.clipboardData.setData('text/plain', copytxt);
                                    alert("复制成功");
                                });
                            });
                        } else {
                            alert(data.info);
                        }
                    });
            });
            $("#myModel .modal-header em").click(function (event) {
                if (confirm("确定关闭？")) {
                    $(".my-dialog").modal("hide");
                }
            });
            /*E-重复订单编辑查看*/

            /*S-初始化筛选条件*/
            $("select[name=city]").select2('val', '{$Think.get.city}' == '' ? '' : '{$Think.get.city}');
            $("select[name=op_uid]").select2('val', '{$Think.get.op_uid}' == '' ? 0 : '{$Think.get.op_uid}');
            $("select[name=status]").val('{$Think.get.status}' == '' ? 0 : '{$Think.get.status}');
            $('select[name=remarks]').val('{$Think.get.remarks}' == '' ? '全部' : '{$Think.get.remarks}');
            $('select[name=displaynumber]').val('{$Think.get.displaynumber}' == '' ? 0 : '{$Think.get.displaynumber}');
            $('select[name=isactivity]').val('{$Think.get.isactivity}' == '' ? 0 : '{$Think.get.isactivity}');
            $('select[name=source]').val('{$Think.get.source}' == '' ? '' : '{$Think.get.source}');
            $('select[name=orderlxs]').val('{$Think.get.lxs}' == '' ? '' : '{$Think.get.lxs}');
            /*E-初始化筛选条件*/

            //tab切换
            $('.ol-tab').on('click', function () {
                cookies.set('order_status_forbidden', 1, 365);
                $('.ol-tab').removeClass('ol-tab-active');
                $(this).addClass('ol-tab-active');
                var status = $(this).attr('data-tab');
                if (status == '0') {
                    cookies.set('order_status_forbidden', 0, 365);
                    window.location.href = '/orders/';
                } else if(status == '26'){
                    window.location.href = "/orders/pauseorderlist";
                } else {
                    var hasAdminId = ['12', '13', '14'];
                    if (hasAdminId.indexOf(status) > -1) {
                        window.location.href = '/orders/?status=' + status + '&op_uid=' + '{$main.defaultOperater}';
                    } else {
                        window.location.href = '/orders/?status=' + status;
                    }
                }
            });

            /*S-重置搜索条件*/
            $('#reset').on('click', function () {
                clearSearchCondition();
            });
            /*E-重置搜索条件*/


            /*S-清空筛选条件*/
            function clearSearchCondition() {
                $('.clear-target').val('');
                $("select[name=city]").select2('val', '0');
                $("select[name=status]").val('0');
                $('select[name=remarks]').val('全部');
                $('select[name=displaynumber]').val('0');
            }

            /*E-清空筛选条件*/

            //筛选城市,查询对应的区县
            $("#city").on('change', function () {
                $.ajax({
                    url: '/city/getAreaByCity/',
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        cid: $(this).val()
                    }
                })
                    .done(function (data) {
                        if (data.status == 1) {
                            var html = '<option value="">请选择</option>';
                            $.each(data.info, function (k, v) {
                                html += '<option value="' + v.qz_areaid + '">' + v.qz_area + '</option>';
                            })
                            $("#area").html(html);
                        }
                    });
            });
        })

        function CloseWebPage() {
            if (navigator.userAgent.indexOf("MSIE") > 0) {
                if (navigator.userAgent.indexOf("MSIE 6.0") > 0) {
                    window.opener = null;
                    window.close();
                } else {
                    window.open('', '_top');
                    window.top.close();
                }
            } else if (navigator.userAgent.indexOf("Firefox") > 0) {
                window.location.href = 'about:blank '; //火狐默认状态非window.open的页面window.close是无效的
                //window.history.go(-2);
            } else {
                window.opener = null;
                window.open('', '_self', '');
                window.close();
            }
        }

        $("body").on("click", "#distance_check", function () {
            var _this = $(this);

            if ($("input[name=zuobiao]").val() == "") {
                alert("请填写业主坐标!");
                return false;
            }

            $.ajax({
                url: '/orders/getorderdistance',
                type: 'POST',
                dataType: 'JSON',
                data: {
                    zuobiao: $("input[name=zuobiao]").val(),
                    cs: $("select[name=cs]").val()
                },
            })
                .done(function (data) {
                    if (data.code == 0) {
                        $("#nowCompanys").find(".distance").each(function (i) {
                            var id = $(this).attr("data-id");
                            if (data.data.hasOwnProperty(id)) {
                                $(this).text(data.data[id]).show();
                            }
                        });

                        $("#otherCompanys").find(".distance").each(function (i) {
                            var id = $(this).attr("data-id");
                            if (data.data.hasOwnProperty(id)) {
                                $(this).text(data.data[id]).show();
                            }
                            _this.attr("data-status", 1);
                        });
                        _this.attr("data-status", 1);
                    } else {
                        alert(data.info);
                    }
                });
        });
    </script>
    <eq name="main.auth.checkcall" value="1">
        <script>
            $(document).ready(function () {
                /*S-呼叫记录查看*/
                $('.tel-history').click(function (event) {
                    var id = $(this).parent().parent().attr('data-id');
                    var _this = $(this);
                    $.ajax({
                        url: '/voip/voiprecord/',
                        type: 'GET',
                        dataType: 'JSON',
                        data: {
                            id: id
                        }
                    })
                        .done(function (data) {
                            if (data.status == '1') {
                                $('.common-model-content').empty();
                                $('.common-model-content').html(data.data);
                                $('.common-model').modal('show');
                            } else {
                                var e = dialog({
                                    title: '消息',
                                    content: data.info,
                                    okValue: '确 定',
                                    quickClose: true,
                                    ok: function () {
                                    }
                                });
                                e.show();
                                return false;
                            }
                        })
                        .fail(function (xhr) {
                            var e = dialog({
                                title: '消息',
                                content: '发生未知错误，请联系技术部门~',
                                okValue: '确 定',
                                quickClose: true,
                                ok: function () {
                                }
                            });
                            e.show();
                            return false;
                        })
                });
                /*E-呼叫记录查看*/

                $('.tback-history').click(function (event) {
                    var id = $(this).attr('data-id');
                    var _this = $(this);
                    $.ajax({
                        url: '/orders/getOrderBackReason/',
                        type: 'POST',
                        dataType: 'JSON',
                        data: {
                            id: id
                        }
                    })
                        .done(function (data) {
                            if (data.error_code == 0) {
                                var html = data.info.reason + '<br/>' + data.info.back_remark;
                                $('.back-model-content').empty();
                                $('.back-model-content').html(html);
                                $('.back-model').modal('show');
                            } else {
                                var e = dialog({
                                    title: '消息',
                                    content: data.error_msg,
                                    okValue: '确 定',
                                    quickClose: true,
                                    ok: function () {
                                    }
                                });
                                e.show();
                                return false;
                            }
                        })
                        .fail(function (xhr) {
                            var e = dialog({
                                title: '消息',
                                content: '发生未知错误，请联系技术部门~',
                                okValue: '确 定',
                                quickClose: true,
                                ok: function () {
                                }
                            });
                            e.show();
                            return false;
                        })
                });
            });
        </script>
    </eq>
</block>
