<extend name="Main:baseTemplate" />
<block name="style">
<link href="/assets/common/js/plugins/datetimepicker/datepicker.css?v={:C('STATIC_VERSION')}" rel="stylesheet" />
<link href="/assets/common/js/plugins/datetimepicker/datetimepicker.css?v={:C('STATIC_VERSION')}" rel="stylesheet" />
<link rel="stylesheet" href="/assets/home/order/css/index.css?v={:C('STATIC_VERSION')}">
<link rel="stylesheet" href="/assets/common/js/plugins/bootstrap-dialog/bootstrap-dialog.min.css?v={:C('STATIC_VERSION')}">
<link rel="stylesheet" type="text/css" href="/assets/common/js/plugins/select2/select2.css?v={:C('STATIC_VERSION')}" />
<link rel="stylesheet" href="/assets/home/orders/css/modifyriz.css?v={:C('STATIC_VERSION')}">
    <script type="text/javascript" src="/assets/common/plugins/layer/layer.js?v={:C('STATIC_VERSION')}"></script>
<style>
.rizhitanchuan {
    left: 3px !important;
    top: 46px !important;
}
</style>
</block>
<block name="content">
    <div class="cover"></div>
<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box box-default">
                <div class="box-header">
                    <div class="row">
                        <div class="col-xs-12 no-padding">
                            <div class="col-xs-1">
                                <p>对接客服：</p>
                                <select class="select2 select2-offscree form-control" name="kf" type="text" placeholder="对接客服" tabindex="-1">
                                    <option value="">请选择</option>
                                    <volist name="kflist" id="vo">
                                    <option value="{$vo.id}">{$vo.name}</option>
                                    </volist>
                                </select>
                            </div>
                            <div class="col-xs-2">
                                <p>订单查询：</p>
                                <input class="form-control" type="text" name="id" placeholder="订单号、小区名称" value="{$Think.get.id}">
                            </div>
                            <div class="col-xs-1">
                                <p>所属区域：</p>
                                <select class="select2 select2-offscree form-control" name="cs" type="text" placeholder="城市" tabindex="-1">
                                    <option value="">请选择</option>
                                    <volist name="citys" id="vo">
                                    <option value="{$vo.cid}">{$vo.cname}</option>
                                    </volist>
                                </select>
                            </div>
                            <div class="col-xs-1">
                                <p>&nbsp;</p>
                                <select class="select2 select2-offscree form-control" name="qx" type="text" placeholder="城市" tabindex="-1">
                                    <option value="">请选择</option>
                                    <volist name="qxs" id="vo">
                                        <option value="{$vo.qz_areaid}" <if condition="$_GET['qx'] eq $vo['qz_areaid']">selected</if>>{$vo.qz_area}</option>
                                    </volist>
                                </select>
                            </div>
                            <div class="col-xs-1">
                                <p>订单状态：</p>
                                <select class="select2 select2-offscree form-control" name="status" type="text" placeholder="城市" tabindex="-1">
                                    <option value="">请选择</option>
                                    <volist name="status" id="vo">
                                    <option value="{$key}">{$vo}</option>
                                    </volist>
                                </select>
                            </div>
                            <if condition="$_GET['type'] NEQ 2">
                            <div class="col-xs-3">
                                <p>推送时间：</p>
                                <div class="col-xs-6" style="padding-left:0;">
                                    <input class="form-control datetimepicker" type="text" name="begin" autocomplete="off" placeholder="订单推送时间" value="{$Think.get.begin}">
                                </div>
                                <div class="col-xs-6">
                                    <input class="form-control datetimepicker" type="text" name="end" autocomplete="off" placeholder="订单推送时间" value="{$Think.get.end}">
                                </div>
                            </div>
                            <else/>
                            <div class="col-xs-1">
                                <p>分配时间：</p>
                                <input class="form-control datetimepicker" type="text" name="begin" placeholder="订单分配时间" value="{$Think.get.begin}">
                            </div>
                            <div class="col-xs-1">
                                <p>&nbsp;</p>
                                <input class="form-control datetimepicker" type="text" name="end" placeholder="订单分配时间" value="{$Think.get.end}">
                            </div>
                            <div class="col-xs-1">
                                <p>对接时长：</p>
                                <select class="select2 select2-offscree form-control" name="timediff" type="text" placeholder="订单对接时长：" tabindex="-1">
                                    <option value="">请选择</option>
                                    <volist name="timediff" id="vo">
                                    <option value="{$key}">{$vo}</option>
                                    </volist>
                                </select>
                            </div>
                            </if>
                        </div>
                        <div class="col-xs-12 no-padding" style="margin-top:10px;">
                            <if condition="in_array(session('uc_userinfo.uid'),$showList)">
                                <div class="col-xs-1">
                                    <p>订单类型:</p>
                                    <select name="isactivity" class="form-control">
                                        <option value="0">全部</option>
                                        <option value="1">活动订单</option>
                                        <option value="2">普通订单</option>
                                    </select>
                                </div>
                            </if>
                            <div class="col-xs-2">
                                <p>订单来源:</p>
                                <select name="source" class="form-control">
                                    <option value="">全部</option>
                                    <volist name="orderType" id="vo">
                                        <option value="{$vo.id}">{$vo.type_name}</option>
                                    </volist>
                                </select>
                            </div>
                            <if condition="$_GET['type'] EQ 4">
                                <div class="col-xs-1">
                                    <p>抢单类型:</p>
                                    <select name="rob_type" class="form-control">
                                        <option value="0">全部</option>
                                        <option value="1">抢分</option>
                                        <option value="2">抢赠</option>
                                    </select>
                                </div>
                            </if>
                            <div class="col-xs-2">
                                <p>&nbsp;</p>
                                <div id="btnreact" class="btn btn-primary btn-sm btn-flat"><i class="fa fa-wrench"></i>&nbsp;重置</div>
                                <div id="btnSearch" class="btn btn-primary btn-sm btn-flat  ml10"><i class="fa fa-search"></i>&nbsp;搜索</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="box-body">
                    <div>
                        <ul class="nav nav-tabs" role="tablist">
                            <li role="presentation" data-id="1"><a class="btn-sm" href="javascript:void(0)" aria-controls="unallocated" role="tab" data-toggle="tab">未分配订单</a></li>
                            <li role="presentation" data-id="2"><a class="btn-sm" href="javascript:void(0)" aria-controls="allocated" role="tab" data-toggle="tab">已分配订单</a></li>
                            <li role="presentation" data-id="3"><a class="btn-sm" href="javascript:void(0)" aria-controls="allocated" role="tab" data-toggle="tab">待分配订单</a></li>
                            <li role="presentation" data-id="4"><a class="btn-sm" href="javascript:void(0)" aria-controls="allocated" role="tab" data-toggle="tab">抢单撤回管理</a></li>
                        </ul>
                        <div class="tab-content">
                            <div role="tabpanel" class="tab-pane active fade in" id="unallocated">
                                <!-- 未分配订单 -->
                                <div class="col-xs-12 no-padding">
                                    <table id="" class="table table-bordered table-hover dataTable no-footer" role="grid" aria-describedby="myTable_info">
                                        <thead>
                                            <tr role="row">
                                                <th>发布日期</th>
                                                <th>订单备注</th>
                                                <if condition="in_array(session('uc_userinfo.uid'),$showList)">
                                                <th>订单类型</th>
                                                </if>
                                                <th>城市区县</th>
                                                <th>完整度</th>
                                                <th>面积㎡</th>
                                                <th>手机号码</th>
                                                <th>订单来源</th>
                                                <th>订单状态</th>
                                                <if condition="$_GET['type'] NEQ 2">
                                                <th>订单推送时间</th>
                                                <else/>
                                                <th>订单分配时间</th>
                                                </if>
                                                <if condition="$_GET['type'] EQ 2">
                                                    <th>分配上限</th>
                                                    <th>已分会员数</th>
                                                </if>
                                                <if condition="$_GET['type'] EQ 4">
                                                    <th>剩余名额</th>
                                                    <th>已抢会员数</th>
                                                    <th>剩余时间</th>
                                                    <th>抢单类型</th>
                                                </if>
                                                <if condition="$_GET['type'] EQ 2 or $_GET['type'] EQ 4">
                                                    <th>对接客服</th>
                                                </if>
                                                <th >操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <volist name="list" id="vo">
                                            <tr role="row" class="odd">
                                                <td>{$vo.time_real|date="Y-m-d H:i:s",###}</td>
                                                <td><span class="text-red">{$vo.remarks}</span></td>
                                                <if condition="in_array(session('uc_userinfo.uid'),$showList)">
                                                <td>
                                                    <if condition="$vo['sourceMark'] EQ 1">
                                                        活动
                                                    <else/>
                                                        普通
                                                    </if>
                                                </td>
                                                </if>
                                                <td><span>{$vo.cname}{$vo.qz_area}</span></td>
                                                <td>{$vo.wzd}</td>
                                                <td>{$vo.mianji}</td>
                                                <td>
                                                    {$vo.tel}
                                                    <if condition="$vo['phone_repeat_count'] GT 1">
                                                        <a title="手机号码重复次数" class="phone-repeat-order red" href="javascript:void(0)" data-id="{$vo.id}">重{$vo['phone_repeat_count'] - 1}
                                                        </a>
                                                    </if>
                                                    <present name="vo.applystatus">{$vo['applystatus']}
                                                        <if condition="$vo['applystatus'] EQ 1">
                                                            <span class="redcolor repairtel" data-id="{$vo.id}">修</span>
                                                            <else/>
                                                            <span class="repairtel" style="color:#008000;cursor:pointer;" data-id="{$vo.id}">修</span>
                                                        </if>
                                                    </present>

                                                </td>
                                                <td>
                                                    <if condition="!empty($vo['source_in'])">
                                                        <volist name="orderType" id="v">
                                                            <if condition="$vo['source_in'] eq $v['id']">
                                                                {$v.type_name}
                                                            </if>
                                                        </volist>
                                                        <else/>
                                                        默认
                                                    </if>
                                                </td>
                                                <td class="order-status">
                                                    <switch name="vo.type_fw">
                                                        <case value="1">分单
                                                            <if condition="$_GET['type'] EQ 4">
                                                                <if condition=" ($vo['allot_num'] - $vo['already_allot_num']) EQ 0">(不可抢)
                                                                <else/>(可抢)
                                                                </if>
                                                            </if>
                                                        </case>
                                                        <case value="2">赠单
                                                            <if condition="$_GET['type'] EQ 4">
                                                                <if condition="($vo['allot_num'] - $vo['already_allot_num']) EQ 0">
                                                                (不可抢)
                                                                <else/>
                                                                (可抢)
                                                                </if>
                                                            </if>
                                                        </case>
                                                        <case value="3">分没人跟</case>
                                                        <case value="4">赠没人跟</case>
                                                        <case value="5">待分配分单</case>
                                                        <case value="6">待分配赠单</case>
                                                    <default/>
                                                    -
                                                    </switch>
                                                </td>
                                                <if condition="$_GET['type'] NEQ 2">
                                                    <if condition="$_GET['type'] EQ 4">
                                                        <td>{$vo.rob_time|date='Y-m-d H:i:s',###}</td>
                                                        <else/>
                                                        <td>{$vo.csos_time}</td>
                                                    </if>
                                                <else/>
                                                <td title="订单对接所用时长:{$vo.date_diff}">{$vo.time|date='Y-m-d H:i:s',###}<br/>
                                                <if condition="$vo['time_diff'] ELT 15">
                                                    <span class="green">{$vo.date_diff}</span>
                                                <else/>
                                                    <span class="red">{$vo.date_diff}</span>
                                                </if>
                                                </td>
                                                </if>
                                                <if condition="$_GET['type'] EQ 2">
                                                    <td>{$vo.allot_num}</td>
                                                    <td>{$vo.already_allot_num}</td>
                                                </if>
                                                <if condition="$_GET['type'] EQ 4">
                                                    <td><?php echo ($vo['allot_num']-$vo['rob_num']) ?></td>
                                                    <td>{$vo.already_allot_num}</td>
                                                    <td>
                                                        <if condition="$vo['order_status'] eq 1">
                                                            {:secToTime(($vo['rob_time'] + 60*60*2) - time())}
                                                            <else/>
                                                            {:secToTime(($vo['rob_time'] + 60*60*1) - time())}
                                                        </if>
                                                    </td>
                                                    <td ><if condition="$vo['order_status'] == 1">抢分<else/>抢赠</if></td>
                                                </if>
                                                <if condition="$_GET['type'] EQ 2 or $_GET['type'] EQ 4">
                                                <td >{$vo.op_uname}</td>
                                                </if>
                                                <td style="text-align:left;">
                                                    <span class="btn btn-default btn-sm  btnEdit" data-id="{$vo.id}" style="float:none">编辑</span>
                                                    <!--只有是分单并且在已分配列表 才能推送-->
                                                    <if condition="$_GET['type'] EQ 2 and (($vo['type_fw'] EQ 1) or ($vo['type_fw'] EQ 3)) and ($vo['time'] gt $day_time) and $vo['is_rob'] NEQ 2 and ($vo['allot_num'] NEQ $vo['already_allot_num'])">
                                                        <span class="btn btn-default btn-sm btn-flat rob_push"
                                                              data-id="{$vo.id}" style="float:none">抢分池</span>
                                                        <if condition="$vo['already_allot_num'] egt 1">
                                                            <span class="btn btn-default btn-sm btn-flat rob_push"
                                                                  data-id="{$vo.id}" data-val="2" style="float:none;margin-right: 0;">抢赠池</span>
                                                        </if>
                                                    </if>
                                                    <!-- <span class="btn btn-default btn-sm btn-flat ml10 tel-history" data-id="{$vo.id}">呼叫记录</span> -->
                                                </td>
                                            </tr>
                                            </volist>
                                        </tbody>
                                    </table>
                                    {$page}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--编辑订单模态框-->
    <div class="modal fade my-dialog" id="operate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" style="width: 1400px;">
            <div class="modal-content">
                <div class="modal-header bg-gray">
                    <em class="close" aria-hidden="true" style="font-style: normal;">×
                </em>
                    <span></span>
                </div>
                <div class="modal-body">
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade common-model" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="z-index: 1049; ">
            <div class="modal-dialog" >
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
                        </button>
                        <h4 class="modal-title">记录列表</h4>
                    </div>
                    <div class="modal-body common-model-content"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade common-phone" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="z-index: 1049; ">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×
                        </button>
                        <h4 class="modal-title">记录列表</h4>
                    </div>
                    <div class="modal-body common-model-phone">
                        <table class="table table-bordered table-hover dataTable no-footer" role="grid">
                            <thead>
                                <tr role="row">
                                    <th class="sorting" tabindex="0" aria-controls="myTable">申请人</th>
                                    <th class="sorting" tabindex="0" aria-controls="myTable">修改理由</th>
                                    <th class="sorting" tabindex="0" aria-controls="myTable">申请时间</th>
                                    <th class="sorting" tabindex="0" aria-controls="myTable">审核人</th>
                                    <th class="sorting" tabindex="0" aria-controls="myTable">审核时间</th>
                                    <th class="sorting" tabindex="0" aria-controls="myTable">审核状态</th>
                                    <th class="sorting applyset" tabindex="0" aria-controls="myTable">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr role="row">
                                    <td class="sorting applyname" tabindex="0" aria-controls="myTable">123</td>
                                    <td class="sorting applyreason" tabindex="0" aria-controls="myTable"></td>
                                    <td class="sorting applytime" tabindex="0" aria-controls="myTable"></td>
                                    <td class="sorting passname" tabindex="0" aria-controls="myTable"></td>
                                    <td class="sorting passtime" tabindex="0" aria-controls="myTable"></td>
                                    <td class="sorting applystatus" tabindex="0" aria-controls="myTable"></td>
                                    <td class="sorting applyset" tabindex="0" aria-controls="myTable" data-id=""><span class="adopt">通过</span><span class="noadopt">不通过</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    <div class="tuisong-model">
        <span>×</span>
        <p class="hint_title">是否将该订单推送至抢分池？</p>
        <div class="model-btn">
            <button type="button" class="btn-no">不推送</button>
            <button type="button" class="btn-tuisong" data-val="1">推送</button>
        </div>
        <input type="hidden" class="push_id">
    </div>
</section>
</block>
<block name="script">
<script src="/assets/common/js/plugins/datetimepicker/bootstrap-datepicker.js?v={:C('STATIC_VERSION')}"></script>
<script src="/assets/common/js/plugins/datetimepicker/bootstrap-datetimepicker.js?v={:C('STATIC_VERSION')}"></script>
<script src="/assets/common/js/plugins/zeroclipboard/ZeroClipboard.min.js?v={:C('STATIC_VERSION')}"></script>
<script src="/assets/common/js/plugins/bootstrap-dialog/bootstrap-dialog.min.js?v={:C('STATIC_VERSION')}"></script>
<script src="/assets/common/js/plugins/select2/select2.min.js?v={:C('STATIC_VERSION')}"></script>
<script src="/assets/home/orders/js/calculator.js?v={:C('STATIC_VERSION')}"></script>
<script type="text/javascript">
    if ($('select[name=timediff]').length > 0) {
        $('select[name=timediff]').select2();
        $('select[name=timediff]').select2("val","{$Think.get.timediff}");
    }


    $('select[name=kf]').select2();
    $('select[name=kf]').select2("val","{$Think.get.kf}");

    $(".nav-tabs li").eq({$Think.get.type|default="1"}-1).addClass('active');
    $('select[name=cs]').select2();
    $('select[name=cs]').select2("val","{$Think.get.cs}");

    $('select[name=status]').select2();
    $('select[name=status]').select2("val","{$Think.get.status}");

    $('select[name=isactivity]').val('{$Think.get.isactivity}' == '' ? 0 : '{$Think.get.isactivity}');
    $('select[name=source]').val('{$Think.get.source}' == '' ? '' : '{$Think.get.source}');

    $('select[name=rob_type]').val('{$Think.get.rob_type}' == '' ? 0 : '{$Think.get.rob_type}');

    $(".datepicker").datepicker({
        format:"yyyy-mm-dd"
    });

    $(".datetimepicker").datetimepicker({
        weekStart: 1,
        todayHighlight: 1,
        todayBtn:true,
        minView:0,
        autoclose: true
    });

    $("body").on("click",".repairtel",function(){
        var id = $(this).attr("data-id");
        $.ajax({
            url: '/orders/showapplyedit/',
            type: 'POST',
            async:false,
            dataType: 'json',
            data: {id:id}
        })
                .done(function(data) {
                    var info = data.info;
                    if (data.code == 200) {
                        $('.applyname').html(info.applyname);
                        $('.applyreason').html(info.apply_reason);
                        $('.applytime').html(info.apply_time);
                        $('.passname').html(info.passname);
                        $('.passtime').html(info.pass_time);
                        $('.applystatus').html(info.applystatus);
                        $('.applyset').attr('data-id',info.orders_id);

                        if(info.status!=1 || data.data !=1){
                            $('.applyset').hide();
                        }else{
                            $('.applyset').show();
                        }
                        $('.common-phone').modal('show');
                    }else{
                        alert(data.errmsg);
                    }
                });

    })

    //通过
    $("body").on("click",".adopt",function(){
        var id = $(this).parent().attr("data-id");
        changeapply(id,2);
    })

    //不通过
    $("body").on("click",".noadopt",function(){
        var id = $(this).parent().attr("data-id");
        changeapply(id,3);
    })

    function changeapply(id,status){
        $.ajax({
            url: '/orders/changeapplyedit/',
            type: 'POST',
            async:false,
            dataType: 'json',
            data: {id:id,status:status}
        })
                .done(function(data) {
                    if (data.code == 200) {
                        alert("操作成功");
                        $('.common-phone').modal('hide');
                    }else{
                        alert(data.errmsg);
                    }
                });
    }
    $(".order-status").each(function (index,item) {
        if($(this).text().trim() == "分单"){
            $(this).parent().find(".tuisong").show();
        }
    });
    $(".btn-no,.tuisong-model span").click(function () {
        $(".tuisong-model").hide();
        $(".cover").hide();
        $("body").css({"overflow":"inherit","height":"100%"})
    });
    $(".rob_push").click(function () {
        $('.push_id').val($(this).attr('data-id'))
        $(".cover").show();
        $(".tuisong-model").show();
        var data_val = $(this).attr('data-val');
        if(data_val == 2){
            $(".hint_title").html('是否将该订单推送至抢赠池？');
        }else {
            $(".hint_title").html('是否将该订单推送至抢分池？');
        }
        $(".btn-tuisong").attr('data-val',data_val);
        $("body").css({"overflow":"hidden","height":"100%"})
    })
    $("body").on("click",".btnEdit",function(event) {
        var id = $(this).attr("data-id");
        $.ajax({
            url: '/orders/editDocking?id='+id,
            type: 'POST',
            dataType: 'json',
            data: {
                id: id,
                type:{$gettype}
            }
        })
        .done(function(data) {
            if (data.code == 200) {
                $('.common-model').modal('hide');
                $("#operate .modal-header span").html("  修改订单  " + data.info.id + " (上次修改  " + data.info.lasttime + "  )   |   实际发布时间:" + data.info.time_real + " |   订单发布完整度：" + data.info.wzd + " %");
                $("#operate .modal-body").html(data.data);

                $("#tic").select2();
                $("#operate").modal({
                    backdrop: false
                }).on("shown.bs.modal",function(){
                    ZeroClipboard.destroy();
                    var client = new ZeroClipboard( $("#copy") );
                        client.on('copy', function (event) {

                               var command_need=$("textarea[name=text]").val();//获取装修要求文本
                                var pre_string = new Array("【1.设计施工要求】：", "【2.材料要求】：", "【3.不含家具家电总预算】：","【4.对装修公司的要求】：","【5.量房注意事项】：","【6.工期】：","【2.不含家具家电总预算】：","【3.对装修公司的要求】：","【4.量房注意事项】：");
                                for(var i=0;i<pre_string.length;i++)
                                {
                                    command_need=command_need.replace(pre_string[i], "");//遍历替换前缀说明
                                }
                                //第一条的时候要加换行\r\n
                                var copytxt = "【齐装网】" + $("[name=qx]").find("option:selected").text() + " "
                                              + $("[name=xiaoqu]").val()  + " "
                                              + $("[name=dz]").val() + " "
                                              +"\r\n "+ command_need + " 业主:" +  $("[name=name]").val()
                                              + $("[name=sex]").find("option:selected").text()
                                              + " 手机上直接查看: " + $("input[name=dwz]").val() ;

                        event.clipboardData.setData('text/plain', copytxt);

                        alert("复制成功");
                    });

                    var company = new ZeroClipboard( $("#copy-company") );
                    company.on('copy', function (event) {
                        var copytxt = "";
                        $(".fen-company").each(function(){
                                copytxt += $(this).text()+" ";
                        });
                        event.clipboardData.setData('text/plain', copytxt);
                        alert("复制成功");
                    });

                    var template = new ZeroClipboard( $("#copy-template") );
                    template.on('copy', function (event) {
                        var copytxt ="";
                        $.ajax({
                            url: '/orders/copytemplate',
                            type: 'POST',
                            async:false,
                            dataType: 'json',
                            data: {tmpid: $("#template").val(),id:$("#copy-template").attr("data-id")}
                        })
                        .done(function(data) {
                            if (data.code == 200) {
                                copytxt = data.data;
                                event.clipboardData.setData('text/plain', copytxt);
                                alert("复制成功");
                            }
                        });
                    });
                });
            } else {
                alert(data.info);
            }
        });
    });

    $("#operate .modal-header em").click(function(event) {
        if (confirm("确定关闭？")) {
            $(".my-dialog").modal("hide");
        }
    });

    $(".nav-tabs li a").click(function(event) {
        $type = $(this).parent().attr("data-id");
        window.location.href = "/orders/docking?type="+$type+"&id="+$("input[name=id]").val()+"&cs="+$("select[name=cs]").val();
    });

    $("#btnSearch").click(function(event) {
        $type = $(".nav-tabs li.active").attr("data-id");
        window.location.href = "/orders/docking?type="+$type+"&id="+$("input[name=id]").val()+"&cs="+$("select[name=cs]").val()+"&begin="+$("input[name=begin]").val()+"&end="+$("input[name=end]").val()+"&status="+$("select[name=status]").val()+"&kf="+$("select[name=kf]").val()+"&timediff="+$("select[name=timediff]").val()+"&isactivity="+$("select[name=isactivity]").val()+"&source="+$("select[name=source]").val()+"&rob_type="+$("select[name=rob_type]").val()+"&qx="+$("select[name=qx]").val();
    });

    $('.tel-history').click(function(event) {
        var id = $(this).attr('data-id');
        var _this = $(this);
        $.ajax({
            url: '/voip/voiprecord/',
            type: 'GET',
            dataType: 'JSON',
            data: {
                id: id
            }
        })
        .done(function(data) {
            if (data.status == '1') {
                $('.common-model-content').empty();
                $('.common-model-content').html(data.data);
                $('.common-model').modal('show');
            } else {
                var e = dialog({
                    title: '消息',
                    content: data.info,
                    okValue: '确 定',
                    quickClose: true,
                    ok: function() {}
                });
                e.show();
                return false;
            }
        })
        .fail(function(xhr) {
            var e = dialog({
                title: '消息',
                content: '发生未知错误，请联系技术部门~',
                okValue: '确 定',
                quickClose: true,
                ok: function() {}
            });
            e.show();
            return false;
        })
    });

    /*S-手机号重复订单*/
    $('.phone-repeat-order').click(function(event) {
        var id = $(this).attr('data-id');
        var _this = $(this);
        $.ajax({
            url: '/orders/getrepeatorderlistbyphone/',
            type: 'POST',
            dataType: 'JSON',
            data: {
                id: id
            }
        })
        .done(function(data) {
            if (data.status == '1') {
                $('.common-model-content').empty();
                $('.common-model-content').html(data.data);
                $('.common-model').modal('show');
            } else {
                var e = dialog({
                    title: '消息',
                    content: data.info,
                    okValue: '确 定',
                    quickClose: true,
                    ok: function() {}
                });
                e.show();
                return false;
            }
        })
        .fail(function(xhr) {
            var e = dialog({
                title: '消息',
                content: '发生未知错误，请联系技术部门~',
                okValue: '确 定',
                quickClose: true,
                ok: function() {}
            });
            e.show();
            return false;
        })
    });

    /*S-IP重复订单*/
    $('.ip-repeat-order').click(function(event) {
        var id = $(this).attr('data-id');
        var _this = $(this);
        $.ajax({
            url: '/orders/getrepeatorderlistbyip/',
            type: 'POST',
            dataType: 'JSON',
            data: {
                id: id
            }
        })
        .done(function(data) {
            if (data.status == '1') {
                $('.common-model-content').empty();
                $('.common-model-content').html(data.data);
                $('.common-model').modal('show');
            } else {
                var e = dialog({
                    title: '消息',
                    content: data.info,
                    okValue: '确 定',
                    quickClose: true,
                    ok: function() {}
                });
                e.show();
                return false;
            }
        })
        .fail(function(xhr) {
            var e = dialog({
                title: '消息',
                content: '发生未知错误，请联系技术部门~',
                okValue: '确 定',
                quickClose: true,
                ok: function() {}
            });
            e.show();
            return false;
        })
    });

    $("body").on("click",".btn-repeatcheck",function(event) {
        var id = $(this).parent().attr("data-id");
        $.ajax({
            url: '/orders/repeatcheck/',
            type: 'POST',
            dataType: 'json',
            data: {
                id: id
            }
        })
        .done(function(data) {
            if (data.code == 200) {
                $("#operate .modal-header span").html("  修改订单  " + data.info.id + " (上次修改  " + data.info.lasttime + "  )   |   实际发布时间:" + data.info.time_real + " |   订单发布完整度：" + data.info.wzd + " %");
                $("#operate .modal-body").html(data.data);
                $("#operate").modal({
                    backdrop: true
                }).on("shown.bs.modal",function(){
                    ZeroClipboard.destroy();
                    var client = new ZeroClipboard( $("#copy") );
                    client.on('copy', function (event) {
                           var command_need=$("textarea[name=text]").val();//获取装修要求文本
                            var pre_string = new Array("【1.设计施工要求】：", "【2.材料要求】：", "【3.不含家具家电总预算】：","【4.对装修公司的要求】：","【5.量房注意事项】：","【6.工期】：","【2.不含家具家电总预算】：","【3.对装修公司的要求】：","【4.量房注意事项】：");
                            for(var i=0;i<pre_string.length;i++)
                            {
                                command_need=command_need.replace(pre_string[i], "");//遍历替换前缀说明
                            }
                            //第一条的时候要加换行\r\n
                            var copytxt = "【齐装网】" + $("[name=qx]").find("option:selected").text() + " "
                                          + $("[name=xiaoqu]").val()  + " "
                                          + $("[name=dz]").val() + " "
                                          +"\r\n "+ command_need + " 业主:" +  $("[name=name]").val()
                                          + $("[name=sex]").find("option:selected").text()
                                          + " 手机上直接查看: " + $("input[name=dwz]").val() ;

                        event.clipboardData.setData('text/plain', copytxt);

                        alert("复制成功");
                    });

                    var company = new ZeroClipboard( $("#copy-company") );
                    company.on('copy', function (event) {
                        var copytxt = "";
                        $(".fen-company").each(function(){
                                copytxt += $(this).text()+" ";
                        });
                        event.clipboardData.setData('text/plain', copytxt);
                        alert("复制成功");
                    });

                    var template = new ZeroClipboard( $("#copy-template") );
                    template.on('copy', function (event) {
                        var copytxt ="";
                        $.ajax({
                            url: '/orders/copytemplate',
                            type: 'POST',
                            async:false,
                            dataType: 'json',
                            data: {tmpid: $("#template").val(),id:$("#copy-template").attr("data-id")}
                        })
                        .done(function(data) {
                            if (data.code == 200) {
                                copytxt = data.data;
                                event.clipboardData.setData('text/plain', copytxt);
                                alert("复制成功");
                            }
                        });
                    });
                });
            } else {
                alert(data.info);
            }
        });
    });

    $("#btnreact").click(function(event) {
        $(".select2").val("").trigger('change');
        $("input[name=id],input[name=begin],input[name=end]").val("");
        $('select[name=isactivity]').val("0");
    });

    $(".btn-tuisong").click(function(event) {
        var id = $('.push_id').val();
        var type = $(this).attr('data-val');
        $.ajax({
            url: '/orders/pushOrderRobPool',
            type: 'POST',
            async:false,
            dataType: 'json',
            data: {id:id,type:type}
        })
            .done(function(data) {
                if(data.code == 200){
                    window.location.href = window.location.href;
                }
                alert(data.errmsg)
            });
    });

    $("body").on("click","#distance_check",function(){
        var _this = $(this);

        if($("input[name=zuobiao]").val() == "") {
            alert("请填写业主坐标!");
            return false;
        }

        $.ajax({
            url: '/orders/getorderdistance',
            type: 'POST',
            dataType: 'JSON',
            data: {
                zuobiao: $("input[name=zuobiao]").val(),
                cs:$("input[name=cs]").val()
            },
        })
            .done(function(data) {
                if (data.code == 0) {
                    $("#nowCompanys").find(".distance").each(function(i){
                        var id = $(this).attr("data-id");
                        if (data.data.hasOwnProperty(id)) {
                            $(this).text(data.data[id]).show();
                        }
                    });

                    $("#otherCompanys").find(".distance").each(function(i){
                        var id = $(this).attr("data-id");
                        if (data.data.hasOwnProperty(id)) {
                            $(this).text(data.data[id]).show();
                        }
                        _this.attr("data-status",1);
                    });
                    _this.attr("data-status",1);
                } else {
                    alert(data.info);
                }
            });
    });

    //筛选城市,查询对应的区县
    $("select[name='cs']").on('change',function () {
        $.ajax({
            url: '/city/getAreaByCity/',
            type: 'GET',
            dataType: 'json',
            data: {
                cid:$(this).val()
            }
        })
            .done(function(data) {
                if (data.status == 1) {
                    var html = '<option value="">请选择</option>';
                    $.each(data.info,function (k,v) {
                        html += '<option value="'+v.qz_areaid+'">'+v.qz_area+'</option>';
                    })
                    $("select[name='qx']").html(html);
                }
            });
    });
</script>
</block>
