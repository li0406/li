<section class="content">
    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-body table-responsive no-padding">
                    <!-- 第一列 -->
                    <form id="myForm" class="col-xs-6 border-r padding5">
                    <div class="basic_info">
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size">发布时间：</span>
                            <span>{$info.time}</span>
                        </div>
                        <if condition="in_array($info['source'],array(18082757))">
                        <div class="col-xs-12 no-padding">
                            <div class="col-xs-6 no-padding">
                                <span class="width_size">页面来源：</span>
                                <select name="source_type" class="width_80">
                                    <option value="18082757">上门量房</option>
                                </select>
                            </div>
                        </div>
                        </if>
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size">&nbsp;IP城市：</span>
                            <span>{$info.cname_ip}</span>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size">手机号码：</span>
                            <span>{$info.tel}</span>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size">备用联系：</span>
                            <input class="width_100" type="text" id="other_contact" name="other_contact" value="{$info['other_contact']}">
                            <span id="other_contact_span" style="color:red"></span>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size">房屋地址：</span>
                            <input class="width_100" type="text" name="dz" value="{$info.dz}">
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size"><i class="red">*</i>联系人：</span>
                            <input class="width_100" type="text" name="name" value="{$info.name}">
                            <select name="sex" id="">
                                <if condition="$info['sex'] EQ '先生'">
                                <option value="">性别</option>
                                <option value="先生" selected="selected">先生</option>
                                <option value="女士">女士</option>
                                <elseif condition="$info['sex'] EQ '女士' " />
                                <option value="">性别</option>
                                <option value="先生">先生</option>
                                <option value="女士" selected="selected">女士</option>
                                <else/>
                                <option value="">性别</option>
                                <option value="先生">先生</option>
                                <option value="女士">女士</option>
                                </if>
                            </select>
                        </div>
                        <div id="order-form">
                            <div class="col-xs-12 no-padding mt3">
                                <span class="width_size">所属区域：</span>
                                <span>{$city[0]["cname"]}</span>
                                <input type="hidden" name="cs" value="{$info['cs']}">
                                <select class="width_80" name="qx">
                                    <option value="">-请选择-</option>
                                    <volist name="city" id="vo">
                                        <if condition="$vo['qz_areaid'] EQ $info['qx']">
                                        <option value="{$vo.qz_areaid}" selected="selected">{$vo.qz_area}</option>
                                        <else/>
                                        <option value="{$vo.qz_areaid}">{$vo.qz_area}</option>
                                        </if>
                                    </volist>
                                </select>
                            </div>
                            <div class="col-xs-12 no-padding">

                                <select name="xiaoqutype" style="width:60px;">
                                    <if condition = "$info['xiaoqu_type'] EQ 1">
                                        <option  class="width_size" selected value="1">小区</option>
                                        <else/>
                                        <option  class="width_size" value="1">小区</option>
                                    </if>
                                    <if condition="$info['xiaoqu_type'] EQ 2">
                                        <option  class="width_size" selected value="2">道路</option>
                                        <else/>
                                        <option  class="width_size" value="2">道路</option>
                                    </if>
                                    <if condition="$info['xiaoqu_type'] EQ 3">
                                        <option  class="width_size" selected value="3">其他</option>
                                        <else/>
                                        <option  class="width_size" value="3">其他</option>
                                    </if>
                                </select>
                                <input class="width_90 xiaoqu-entry" type="text" name="xiaoqu" autocomplete="off" value="{$info.xiaoqu}" maxlength="20" style="height:20px;">
                                <div class="xiaoqu-box">

                                    <ul id="xiaoqu_ul">

                                    </ul>
                                </div>
                                <span>坐标：</span>

                                <input class="width_130" type="text" name="zuobiao" style="height:20px;" value="{$info.jingwei}">
                            </div>
                            <div class="col-xs-12 no-padding mt3">
                                <span class="width_size">装修类型：</span>
                                <select name="lx" class="width_70">
                                    <option value="">-请选择-</option>
                                    <if condition="$info['lx'] EQ 2">
                                    <option value="2" selected="selected">公装</option>
                                    <option value="1">家装</option>
                                    <elseif condition="$info['lx'] EQ 1" />
                                    <option value="2">公装</option>
                                    <option value="1" selected="selected">家装</option>
                                    <else/>
                                    <option value="2">公装</option>
                                    <option value="1">家装</option>
                                    </if>
                                </select>
                                <select name="lxs" class="width_80">
                                    <option value="">-请选择-</option>
                                    <volist name="lxs" id="vo">
                                        <if condition="$key EQ $info['lxs']">
                                        <option value="{$key}" selected="selected">{$vo}</option>
                                        <else/>
                                        <option value="{$key}">{$vo}</option>
                                        </if>
                                    </volist>
                                </select>
                            </div>
                            <div class="col-xs-12 no-padding mt3">
                                <span class="width_size">户型结构：</span>
                                <select name="huxing" class="width_100">
                                    <option value="">-请选择-</option>
                                    <volist name="huxing" id="vo">
                                        <if condition="$vo['id'] EQ $info['huxing']">
                                        <option value="{$vo.id}" selected="selected">{$vo.name}</option>
                                        <else/>
                                        <option value="{$vo.id}">{$vo.name}</option>
                                        </if>
                                    </volist>
                                </select>
                                <select name="shi" class="width_50">
                                    <volist name="shi" id="vo">
                                        <if condition="$vo EQ $info['shi']">
                                        <option value="{$key}" selected="selected">{$vo}</option>
                                        <else/>
                                        <option value="{$key}">{$vo}</option>
                                        </if>
                                    </volist>
                                </select>
                                <span>室</span>
                                <span>面积：</span>
                                <input class="width_60" type="text" name="mianji" value="{$info.mianji}">㎡
                            </div>
                            <div class="col-xs-12 no-padding mt3">
                                <span class="width_size">风格：</span>
                                <select name="fengge" class="width_70">
                                    <option value="">-请选择-</option>
                                    <volist name="fengge" id="vo">
                                        <if condition="$vo['id'] EQ $info['fengge']">
                                        <option value="{$vo.id}" selected="selected">{$vo.name}</option>
                                        <else/>
                                        <option value="{$vo.id}">{$vo.name}</option>
                                        </if>
                                    </volist>
                                </select>
                                <span>预算：</span>
                                <select class="width_70" name="fangshi">
                                    <option value="">-请选择-</option>
                                    <volist name="fangshi" id="vo">
                                        <if condition="$vo['id'] EQ $info['fangshi']">
                                        <option value="{$vo.id}" selected="selected">{$vo.name}</option>
                                        <else/>
                                        <option value="{$vo.id}">{$vo.name}</option>
                                        </if>
                                    </volist>
                                </select>
                                <select class="width_70" name="yusuan">
                                    <option selected="" value="">-请选择-</option>
                                    <volist name="yusuan" id="vo">
                                        <if condition="$vo['id'] EQ $info['yusuan']">
                                        <option value="{$vo.id}" selected="selected">{$vo.name}</option>
                                        <else/>
                                        <option value="{$vo.id}">{$vo.name}</option>
                                        </if>
                                    </volist>
                                </select>
                            </div>
                            <div class="col-xs-12 no-padding mt3">
                                <span class="width_size">拿房时间：</span>
                                <input type="text" name="nf_time" class="lf_datepicker inputer width_100" value="{$info['nf_time']}">
                                <span class="width_size">钥匙：</span>
                                <select class="key_select width_70" name="keys">
                                    <option value="">-请选择-</option>
                                    <volist name="keys" id="vo">
                                        <if condition="$key EQ $info['keys']">
                                        <option value="{$key}" selected="selected">{$vo}</option>
                                        <else/>
                                        <option value="{$key}">{$vo}</option>
                                        </if>
                                    </volist>
                                </select>
                            </div>
                            <div class="col-xs-12 no-padding mt3">
                                <span class="width_size">量房时间：</span>
                                <select class="width_100" name="lftime">
                                    <option value="">-请选择-</option>
                                    <volist name="lf_time" id="vo">
                                        <if condition="$vo EQ $info['lftime']">
                                        <option value="{$vo}" selected="selected">{$vo}</option>
                                        <else/>
                                        <option value="{$vo}">{$vo}</option>
                                        </if>
                                    </volist>
                                </select>
                                <span class="width_size">开工时间：</span>
                                <select class="width_100" name="start">
                                    <option value="">-请选择-</option>
                                    <volist name="start_time" id="vo">
                                        <if condition="$vo EQ $info['start']">
                                        <option value="{$vo}" selected="selected">{$vo}</option>
                                        <else/>
                                        <option value="{$vo}">{$vo}</option>
                                        </if>
                                    </volist>
                                </select>
                            </div>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size pull-left">特殊需求：</span>
                            <textarea class="pull-left text-height120" name="text" style="line-height: 12px;">{$info.text}</textarea>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size pull-left">回访记录：</span>
                            <textarea class="pull-left text-height60" name="huifan" >{$info.huifan}</textarea>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size">待定时间：</span>
                            <input type="text" name="visitime" class="datepicker width_120" value="{$info['visitime']}" style="height: 20px;">
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size">编辑人：</span>
                            <span>{$info.customer}</span>

                          <!--  <present name="apply.status">
                                <if condition="($apply['status'] eq 2) AND ($apply['save_state'] eq 1)">
                                    <button id="btnSave" type="button" class="btn btn-info btn-sm pull-right width_60">①保存</button>
                                </if>
                                <else/>
                                <button id="btnEdits" type="button" class="btn btn-info btn-sm pull-right width_60">修改</button>
                            </present>-->
                        </div>
                        <div class="col-xs-12 no-padding border-t" style="margin-top: 2px;display: none;">
                            <span class="red">*</span>
                            <span>分配上限：</span>
                            <input type="radio" name="march-num" class="march-num" id="four-mar"  <if condition="$info['allot_num'] EQ 4 OR empty($info['allot_num'])">checked</if> disabled/><label for="four-mar">4家</label>
                            <input type="radio" name="march-num" class="march-num" id="three-mar" <if condition="$info['allot_num'] EQ 3">checked</if> disabled/><label for="three-mar">3家</label>
                            <input type="radio" name="march-num" class="march-num" id="two-mar" <if condition="$info['allot_num'] EQ 2">checked</if> disabled/><label for="two-mar">2家</label>
                            <input type="radio" name="march-num" class="march-num" id="one-mar" <if condition="$info['allot_num'] EQ 1">checked</if> disabled/><label for="one-mar">1家</label>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span class="width_size">当前状态：</span>
                            <span class="red">
                            <if condition="$info['on'] EQ 0 AND $info['on_sub'] EQ 10">
                            新单
                            <elseif condition="$info['on'] EQ 0 AND $info['on_sub'] EQ 9"/>
                            次新单
                            <elseif condition="$info['on'] EQ 2"/>
                            待定
                            <elseif condition="$info['on'] EQ 4 AND $info['type_fw'] EQ 0"/>
                            有效未分配
                            <elseif condition="$info['on'] EQ 4 AND $info['type_fw'] EQ 1"/>
                            分单
                            <elseif condition="$info['on'] EQ 4 AND $info['type_fw'] EQ 2"/>
                            赠单
                            <elseif condition="$info['on'] EQ 4 AND $info['type_fw'] EQ 3"/>
                            分没人跟
                            <elseif condition="$info['on'] EQ 4 AND $info['type_fw'] EQ 4"/>
                            赠没人跟
                            <elseif condition="$info['on'] EQ 4 AND $info['type_fw'] EQ 5"/>
                            待分配分单
                            <elseif condition="$info['on'] EQ 4 AND $info['type_fw'] EQ 6"/>
                            待分配赠单
                            <elseif condition="$info['on'] EQ 0 AND $info['on_sub'] EQ 8"/>
                            扫单
                            <elseif condition="$info['on'] EQ 5"/>
                            无效
                            <else/>
                            未知
                            </if>
                            <i class="fa fa-long-arrow-right mr10"></i></span>
                            <select name="state" class="select_order_state width_90">
                                <option value="">请选择</option>
                            <volist name="status" id="vo">
                                <option value="remark_{$vo.id}">{$vo.name}</option>
                            </volist>
                            </select>
                            <volist name="status" id="vo" key="$key">
                                <if condition="count($vo['child']) GT 0">
                                    <if condition="$key EQ 0">
                                    <select id="remark_{$vo.id}" class="select_order_item width_150">
                                    <else/>
                                    <select id="remark_{$vo.id}" class="select_order_item width_150 hide_select">
                                    </if>
                                    <option value="">-请选择备注-</option>
                                    <volist name="vo.child" id="v" key="k">
                                        <if condition="$v EQ $info['remarks']">
                                            <option value="{$v}" selected="selected">{$v}</option>
                                            <else/>
                                            <option value="{$v}">{$v}</option>
                                        </if>
                                    </volist>
                                    </select>
                                </if>
                            </volist>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span>审核人：</span>
                            <span>{$csos_new.user_name}</span>
                        </div>
                    </div>
                    </form>
                    <!-- 第二列 -->
                    <div class="col-xs-6 padding10">
                        <div class="col-xs-12 no-padding mt3">
                            <span>分单人：</span>
                            <if condition="$info['on'] EQ 4">
                                <span>{$info.fen_customer}</span>
                            </if>
                            <span>分配状态：</span>
                            <if condition="$info['on'] EQ 4 AND $info['type_fw'] EQ 1">
                            <span>分</span>
                            <elseif condition="$info['on'] EQ 4 AND $info['type_fw'] EQ 2" />
                            <span>赠</span>
                            <else/>
                            </if>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span>已分配公司：</span>
                            <!--<button id="copy-company" type="button" class="width_60 zclip"><i class="fa fa-files-o"></i>复制</button>-->
                            <span>群公布模板：</span>
                            <select id="template" class="width_80">
                                <option value="">请选择</option>
                                <volist name="notice" id="vo">
                                <option value="{$vo.id}">{$vo.title}</option>
                                </volist>
                            </select>
                            <!--<button id="copy-template" type="button" class="width_60 zclip" data-id="{$info.id}"><i class="fa fa-files-o"></i>复制</button>-->
                        </div>
                        <div class="col-xs-12 no-padding mt3 wx_company_list" style="min-height: 60px;">
                            <volist name="company" id="vo">
                                <div class="col-xs-6 no-padding">
                                    <div class="lh16">
                                        <if condition="$vo['type_fw'] EQ 1">
                                            <span>分</span>
                                            <else/>
                                            <span>赠</span>
                                        </if>
                                        <if condition="$vo['isread'] EQ 0">
                                            <span class="red fen-company">{$vo.jc}</span>
                                            <else/>
                                            <span class="green fen-company">{$vo.jc}</span>
                                        </if>
                                    </div>
                                </div>
                            </volist>
                        </div>

                        <div class="col-xs-12 no-padding mt3" id="nowCompanys">
                            <volist name="nowCompanys" id="vo">
                                <p class="red">【{$vo.qz_area}】</p>
                                <div class="col-xs-12 no-padding">
                                    <volist name="vo.child" id="v">
                                        <div class="col-xs-6 no-padding">
                                            <label>
                                                <if condition="isset($v['ischeck'])">
                                                    <input type="checkbox" class="mr5" data-id="{$v.id}" data-name="{$v.jc}" name="fen_company" checked <if condition="$v['no_change'] eq 1">disabled</if>>
                                                <else/>
                                                <input type="checkbox" class="mr5" data-id="{$v.id}" data-name="{$v.jc}" name="fen_company">
                                                </if>
                                                <if condition="$v['wxcount'] GT 0">
                                                <span class="green" data-toggle="tooltip" data-placement="top" title="{$v.tags|default=''}">{$v.jc}</span>
                                                <else/>
                                                <span class="red" data-toggle="tooltip" data-placement="top" title="{$v.tags|default=''}">{$v.jc}</span>
                                                </if>
                                                <span class="green">[{$v.fen|default=0},{$v.qiang|default=0},{$v.zen|default=0}]</span>
                                                <if condition="isset($v['end_time'])">
                                                <span class="red">到 {$v.end_time}</span>
                                                </if>
                                                <if condition="isset($v['newMark'])">
                                                <span class="green">新</span>
                                                </if>
                                                <span class="green">
                                                <switch name="v.viptype">
                                                <case value="0.5">半</case>
                                                <case value="1.5">一倍半</case>
                                                <case value="2">双</case>
                                                <case value="2.5">二倍半</case>
                                                <case value="3">三</case>
                                                <case value="3.5">三倍半</case>
                                                <case value="4">四</case>
                                                <case value="4.5">四倍半</case>
                                                <case value="5">五</case>
                                                </switch>
                                                </span>
                                                <span data-id="{$v.id}" class="distance" style="color: #3399FF;display: none">{$v.distance}</span>
                                            </label>
                                        </div>
                                    </volist>
                                </div>
                            </volist>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span>{$info.cname}上次分配公司：</span>
                            <div>
                                <volist name="fenpei_now_company" id="vo">
                                    <span class="col-xs-3 text-center" style="padding:0 5px;">{$vo.jc}</span>
                                </volist>
                            </div>
                        </div>
                        <div class="col-xs-12 no-padding mt3">
                            <span>最近30天过期会员：</span>
                            <div class="row">
                                <volist name="lostCompany" id="vo">
                                    <div class="col-sm-3 text-center" style="padding: 0 3px;">
                                        <span class="red">{$vo.jc}</span><span>已过期<i class="red">{$vo.day}</i>天</span>
                                    </div>
                                </volist>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mask"></div>
</section>
<script type="text/javascript">

    $("body").on("click","#btnEdits",function () {
        $(".applygaiwk").show();
    })

    $('.applygaiwkhang .closegb').click(function () {
        $(".applygaiwk").hide();
    })


    tel_repeat();
    //备用联系鼠标移出
    $("#other_contact").on('blur',function(){
        $("#other_contact_span").text('');
        tel_repeat();
    })

    function tel_repeat(){
        var other_contact = trim($("#other_contact").val());
        var phone = other_contact.replace(/[^0-9]/g, "");
        if(phone!= ''){
            $.ajax({
                url: '/order/tel_repeat',
                type: 'POST',
                dataType: 'JSON',
                data: {
                    phone: phone
                }
            })
                    .done(function(data) {
                        if (data.status == 0) {
                            $("#other_contact_span").text(data.info);
                        }
                    });
        }
    }

$('.datepicker').datetimepicker({
    weekStart: 1,
    todayHighlight: 1,
    todayBtn:true,
    minView:0,
    pickerPosition: "bottom-left",
    autoclose: true
});

$(".lf_datepicker").datepicker({
    format: "yyyy-mm-dd",
    minViewMode: 0,
    autoclose: true
}).on('changeDate', function(ev) {
    var val = $("textarea[name=text]").val();
    val += " " + $("input[name=nf_time]").val();
    $("textarea[name=text]").val(val);
});

$('#icon_eye').on('click', function() {
    $('.show_callnum_pop').fadeIn();
    $('.mask').fadeIn();
});

$('.call_pop_close').on('click', function() {
    $('.call_pop').fadeOut();
    $('.show_callnum_pop').fadeOut();
    $('.mask').fadeOut();
});

$('.callnum_pop_ok').on('click', function() {
    $.ajax({
            url: '/order/tel_openeye',
            type: 'POST',
            dataType: 'JSON',
            data: {
                id: '{$info.id}',
                "text": $('.show_callnum_pop textarea').val()
            }
        })
        .done(function(data) {
            if (data.code == 200) {
                $('.show_callnum_pop').fadeOut();
                $('.mask').fadeOut();
            } else {
                alert(data.errmsg || data.info);
            }
        });
});

$("#icon_email").click(function(event) {
    var _this = $(this);

    if (_this.hasClass('icon_email_disabled')) {
        return false;
    }

    if (!confirm("确定发送短信通知?")) {
        return false;
    }

    $.ajax({
        url: '/sms/sendsms/',
        type: 'POST',
        dataType: 'JSON',
        data: {
            id: "{$info.id}"
        }
    })
    .done(function(data) {
        if (data.code == 200) {
            alert("短信发送成功！");
            _this.addClass('icon_email_disabled');
        } else {
            alert(data.errmsg || data.info);
        }
    });
});


$('.select_order_state').on('change', function() {
    var id = $(this).val();
    $('.select_order_item').addClass('hide_select');
    $("#" + id).removeClass('hide_select');
    $('.order_note').show();
    if ($("#" + id).length == 0) {
        $('.order_note').hide();
    }
});
$('.select_order_state').trigger('change');

// 钥匙选择字体变化
$('.key_select').on('change', function() {
    if ($('.key_select option:selected').val() == '1') {
        $(this).removeClass('red').addClass('green').addClass('key_select_option');
    } else if ($('.key_select option:selected').val() == '0') {
        $(this).removeClass('green').addClass('red').addClass('key_select_option');
    } else {
        $(this).removeClass('green').removeClass('red').removeClass('key_select_option');
    }
});
$('.key_select').trigger('change');

$(".icon_headset").click(function(event) {
    var _this = $(this);
    if (!confirm("确定IP话机拨打电话?")) {
        return false;
    };
    $.ajax({
        url: '/voip/tel_voipcallback',
        type: 'POST',
        dataType: 'JSON',
        data: {
            id: _this.attr("data-id")
        }
    })
    .done(function(data) {
        if (data.code == 200) {
            alert(data.errmsg);
        } else {
            alert(data.errmsg || data.info);
        }
    });
});

$('.call_pop_close').on('click', function() {
    $('.call_pop').fadeOut();
    $('.show_callnum_pop').fadeOut();
    $('.mask').fadeOut();
    $('body').css('overflowY', 'auto');
});


$("#btnCheck").on("click", function(event) {
    var _this = $(this);
    var status = $(".select_order_state").val();
    var sub_status = $("#" + status).val();
    if($(".select_order_state").val() == "remark_2" && $(".select_order_item").val() == ""){
      alert("请选择备注");
      return;
    }
    if($(".select_order_state").val() == "remark_7"){
      if(!confirm("是否确认直接赠送给装修公司（确认后，不可更改业主信息）")){
        return;
      }
    }
    if(!status){
        alert("请选择订单状态后 , 再审核");
        return;
    }
    $.ajax({
      url: '/orders/orderdockingstatus/',
      type: 'POST',
      dataType: 'JSON',
      data: {
        id: "{$info.id}",
        status: status,
        sub_status: sub_status,
        gettype: 1
      }
    })
      .done(function(data) {
        if (data.code == 200) {
          _this.attr('disabled',true);
          alert("订单审核操作成功！");
          switch (status) {
              //如果 对接操作 选择的是分单 , 则显示分配按钮
              case 'remark_5':
                  $("#btnFen").show();
                  break;
              //如果 对接操作 选择的是[推送抢单池]/[直接赠送] , 则隐藏分配按钮
              case 'remark_6':
              case 'remark_7':
                  $("#btnFen").hide();
                  break;
          }
        } else {
          alert(data.errmsg || data.info);
        }
      });
});

$("#icon_weixin").click(function(event) {
    $('.weixin-model').fadeIn(200);
    $(".mask").show();
});

$("#icon_email_send").click(function(event) {
    if (confirm("确定发送短信吗?")) {
        $.ajax({
            url: '/orders/sendsms/',
            type: 'POST',
            dataType: 'JSON',
            data: {
                id: "{$info.id}"
            }
        })
        .done(function(data) {
            if (data.code == 200) {
                alert("短信发送成功！");
                $(".icon_email").addClass('icon_email_open').attr("title","短信已发送");
            } else {
                alert(data.errmsg || data.info);
            }
        });
    };
});

$('.weixin-model').find('.btn-close').on('click', function() {
    $('.weixin-model').fadeOut(200);
    $('.mask').hide(200);
});

$('.weixin-model').find('.btn-ok').on('click', function() {
    var companys = new Array();
    var data = new Array();
    var _this = $(this);
    $("input[name=wx_company]").each(function() {
        if ($(this).prop("checked")) {
            companys.push($(this).attr("data-id"));
        };
    });
    data.push({
        name: "companys",
        value: companys
    });
    data.push({
        name: "id",
        value: "{$info.id}"
    });

    $.ajax({
        url: '/order/sendwx/',
        type: 'POST',
        dataType: 'JSON',
        data: data
    })
    .done(function(data) {
        alert(data.errmsg || data.info);
        if (data.code == 200) {
            $('.weixin-model').fadeOut(200);
            $('.mask').hide(200);
            $("#icon_weixin").find(".icon_weixin2").addClass('icon_weixin1').removeClass('icon_weixin2');
        }
    });
});

$("#btnFen").click(function(event) {
    //可分配数
    var allot_num = '{$info.allot_num|default=4}';

    if ($("input[name=fen_company]:checked").length == 0) {
        alert("请选择分配装修公司");
        return false;
    }

    if ($("input[name=fen_company]:checked").length > allot_num) {
        alert("只能选择" + allot_num + "家装修公司");
        return false;
    }
    var tmp = "";
    $("input[name=fen_company]:checked").each(function() {
        tmp += '<div class="col-xs-6 no-padding mt20"><select name="select_company" class="pull-right" data-id="' + $(this).attr("data-id") + '"><option value="">-请选择-</option><option value="1">分单</option><option value="2">赠单</option></select><span class="zxgs-name pull-right mr10">' + $(this).attr("data-name") + '</span></div>';
    });
    $(".zxgs-fen-list").html(tmp);
    $('.fenpei-model').fadeIn(200);
    $('.mask').show(200);

});

// 取消分配
$('.fenpei-model .btn-close').on('click', function() {
    $('.fenpei-model').fadeOut(200);
    $('.mask').fadeOut(200);
});

$("#btnUp").click(function(event) {
    var data = {};
    var compnay = new Array();
    data["id"] = "{$info.id}";
    data['type']  = "{$gettype}";
    data['lftime']  = "{$info['lftime']}";
    $(".zxgs-fen-list select").each(function() {
        compnay.push({
            compnay_id: $(this).attr("data-id"),
            "type_fw": $(this).val()
        });
    });
    data["companys"] = compnay;

    $.ajax({
        url: '/orders/orderchange/',
        type: 'POST',
        dataType: 'JSON',
        data: data
    })
    .done(function(data) {
        if (data.code == 200) {
            alert(data.msg);
            if (data.info == 1) {
                $(".icon_email").addClass('icon_email_open').attr("title","短信已发送");
            }
            $('.fenpei-model .btn-close').trigger('click');
            $(".order-tool").addClass('order-tool-open');
            var compnays = data.data;
            var tmp = "";
            var qq ,qq1  = "";
            var type_fw ="";
            var wx_tmp = "";
            for(var i in compnays){
                if (parseInt(compnays[i].type_fw) == 1) {
                    type_fw = "分";
                } else {
                    type_fw = "赠"
                }

                if (compnays[i].qq !== "") {
                    qq = '<a href="http://wpa.qq.com/msgrd?v=3&uin='+compnays[i].qq+'&site=qq&menu=yes" target="_blank"><i class="relation_icon icon_qq"></i></a>';
                }

                if (compnays[i].qq1 !== "") {
                    qq1 = '<a href="http://wpa.qq.com/msgrd?v=3&uin='+compnays[i].qq1+'&site=qq&menu=yes" target="_blank"><i class="relation_icon icon_qq"></i></a>';
                }

                tmp +=  '<div class="col-xs-6 no-padding"><span>'+type_fw+'</span><span class="red fen-company">'+compnays[i].jc+'</span>'+qq+' '+qq1+'</div></div>';

                wx_tmp += '<div class="col-xs-6 no-padding mt10"><label><input id="wx_company_'+i+'" type="checkbox" name="wx_company" data-id="'+compnays[i].id+'" checked><label for="wx_company_'+i+'" class="company-name"></label>'+compnays[i].jc+'</label></div>';

            }
            $(".weixin-model .zxgs-list").html(wx_tmp);
            $(".wx_company_list").html(tmp);
        } else {
            alert(data.errmsg || data.info);
        }
    });
});

$("#history").click(function(event) {
    BootstrapDialog.show({
        title: "历史签单小区",
        message: function(dialog) {
            var $message = $('<div style="margin:-15px; overflow-y:auto; max-height:400px;"></div>');
            var pageToLoad = dialog.getData('pageToLoad');
            $message.load(pageToLoad);

            return $message;
        },
        data: {
            'pageToLoad': '/order/history?xiaoqu={$info.xiaoqu}&cs={$info.cs}'
        },
        type: BootstrapDialog.TYPE_DEFAULT,
        onshow:function(e){
            e.$modalDialog.css("width","400px");
        }
    });
});

    /*小区input下拉*/
    $(".xiaoqu-entry").click(function(event){
        $(".xiaoqu-box").show();
        if($(".xiaoqu-box").val() == ""){
            $(".xiaoqu-box ul li").click(function(){
                $('.xiaoqu-entry').val($(this).html());
                //小区道路显示
                $("select[name=xiaoqutype]").val( $(this).attr("data-type"));
                //坐标显示
                $("input[name=zuobiao]").val( $(this).attr("data-jw"));
                $(".xiaoqu-box").hide();
            })
        }

        $('.xiaoqu-entry').change(function(){
            $(".xiaoqu-box").show();
            var result = $('.xiaoqu-entry').val();
            for(var i = 0 ; i < $(".xiaoqu-box ul li").length ; i++){
                var oLiResult = $(".xiaoqu-box ul li").eq(i).html();
                if(oLiResult.indexOf(result) != -1){
                    $(".xiaoqu-box ul li").eq(i).show();
                    $(".xiaoqu-box ul li").eq(i).click(function(){
                        $('.xiaoqu-entry').val($(this).html());
                        $("input[name=zuobiao]").val( $(this).attr("data-jw"));
                        $(".xiaoqu-box").hide();
                    })
                }else{
                    $(".xiaoqu-box ul li").eq(i).hide();
                }
            }
        })
        event.stopPropagation();
    })
    $(window).click(function(){
        $(".xiaoqu-box").hide();
    })

$("#btnNoNew").click(function(event) {
    BootstrapDialog.show({
        title: "不能生成原因",
        message: function(dialog) {
            var $message = $('<textarea id="content" placeholder="填写原因"></textarea>');
            return $message;
        },
        type: BootstrapDialog.TYPE_INFO,
        buttons: [{
            label: '确定',
            action: function(dialogItself) {
                $.ajax({
                    url: '/order/ordertonewchange',
                    type: 'POST',
                    dataType: 'JSON',
                    data: {
                        id: '{$info.id}',
                        "text": $("#content").val()
                    },
                })
                .done(function(data) {
                    if (data.code == 200) {
                        alert("操作成功！");
                         $(".my-dialog").modal("hide");
                    } else {
                        alert(data.errmsg || data.info);
                    }
                });
                dialogItself.close();
            }
        }, {
            label: '关闭',
            action: function(dialogItself) {
                dialogItself.close();
            },
            cssClass: 'pull-left'
        }]
    });
});

$("#order-form input[type=text]:not(input[name=nf_time],input[name=xiaoqu])").blur(function(event) {
    var val = $("textarea[name=text]").val();
    val += " " + $(this).val();
    $("textarea[name=text]").val(val);
});

$("#order-form select:not(select[name=qx])").change(function(event) {
    var val = $("textarea[name=text]").val();
    val += " " + $(this).find("option:selected").text();
    $("textarea[name=text]").val(val);
});

$("#btnNew").click(function(event) {
    if (confirm("确定生成新单吗？")) {
        $.ajax({
            url: '/order/ordernftoneworder',
            type: 'POST',
            dataType: 'JSON',
            data: {
                id: '{$info.id}'
            },
        })
        .done(function(data) {
            if (data.code == 200) {
                alert(data.errmsg);
                $(".my-dialog").modal("hide");
            } else {
                alert(data.errmsg || data.info);
            }
        });
    }
});

    //修改区域,获取对应区域的小区名称
    $("input[name=xiaoqu]").on("input propertychange",function(){
        var cs = $('input[name=cs]').val();
        var xiaoqu = $.trim($("input[name=xiaoqu]").val());
        if(cs != '' && xiaoqu != ''){
            $.ajax({
                url: '/orders/getcommunitybycity/',
                type: 'GET',
                dataType: 'JSON',
                data: {
                    cs:cs,xiaoqu:xiaoqu

                }
            })
                    .done(function(data) {
                        if (data.status == 0) {
                            //下拉框内容
                            $("#xiaoqu_ul").html(data.data);
                            $(".xiaoqu-box").show();
                        } else {
                            alert(data.errmsg || data.info);
                        }
                    });
        }
    });

//保存
$("#btnSave").on("click", function(event) {
    if(confirm("保存后将不可再次修改，是否确定保存？")){
        //小区名不为空
        var xiaoqu = $.trim($("input[name=xiaoqu]").val());
//        if(xiaoqu== ''){
//            alert("请填写小区名");
//            return false;
//        }else{
//            var regex = new RegExp("^([\u4E00-\uFA29]|[\uE7C7-\uE7F3]|[a-zA-Z0-9_]){1,20}$");
//            if(!regex.test(xiaoqu)){
//                alert("小区名称只允许输入数字字母中文");
//                return false;
//            }
//        }
        //经纬度不为空
//        if($("input[name=zuobiao]").val() == ''){
//            alert("请填写经纬度");
//            return false;
//        }
        //量房时间不为空
        if($("select[name=lftime]").val() == ''){
            alert("请填写量房时间");
            return false;
        }

        var data = $("#myForm").serializeArray();
        data.push({
            name: "id",
            value: "{$info.id}"
        });
        data.push({
            name: "pagetype",
            value: 2
        });

        $.ajax({
            url: '/orders/orderup/',
            type: 'POST',
            dataType: 'JSON',
            data: data
        })
        .done(function(data) {
            if (data.code == 200) {
                alert("业主信息保存成功");
                $("#btnSave").hide();
            } else {
                alert(data.errmsg || data.info);
            }
        });
    }
});
//申请修改
    $("#btnEdit").on("click", function(event) {
        var orders = "{$info.id}";
        var reason = $('.liyoutext').val();

        $.ajax({
            url: '/orders/applyedit/',
            type: 'POST',
            dataType: 'JSON',
            data: {orders:orders,reason:reason}
        })
                .done(function(data) {
                    if (data.code == 200) {
                        alert("申请成功");
                        window.location.reload();
//                        $(".applygaiwk").hide();
//                        $("#btnEdits").hide();
                    } else {
                        alert(data.errmsg);
                    }
                });
    });

    $('.modifyrizhi').click(function(){
        var _this = $(this);
        $.ajax({
            url: '/orders/getorderfieldstat',
            type: 'POST',
            dataType: 'JSON',
            data: {id: _this.attr("data-id")}
        })
        .done(function(data) {
            if (data.status == 1) {
                _this.parents(".border-r").append(data.data)
            } else {
                alert(data.info);
            }
        });
    });
</script>
